---
title: "Detection of k-mers associated to bioclim variables"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(Biostrings)
library(karyoploteR)
library(Rsamtools)
library(rtracklayer)
library(GenomicRanges)
library(Biostrings)
library(circlize)
library(XML)
library(topGO)
library(cowplot)
```


This work is mainly done on IFB cluster.


## Objectives
The purpose is to detect kmers associated with bioclim variables (and maybe also elevation data), using the native samples in Africa.    
Firstly, the Kiss pipeline will be applied to obtain a kmer data set, and detect kmers under selection (associated with population structure, that will be useful for the association test).   
Secondly, I will apply lfmm with different strategies (the whole kmer data set, the putatively adaptive kmers, putatively adaptive kmers + neutral kmers). Then, I will check the distribution of the p-values and/or q-values to determine which strategy is better in terms of minimizing false positives. 
Finally, the significant kmers will be mapped on the reference genome and assembled for annotations ... (to be developed)


## Previously sequenced samples

55 African individuals were sequenced using Illumina.  
They are representative of the 8 genetic groups and consist of some admixed individuals.  

They were cleaned by filtering adapters and trimming low-quality read bases.

removing adapters by fastp 0.23.1: 
`fastp --detect_adapter_for_pe --disable_quality_filtering --disable_length_filtering`  
trimming read bases < Q20 (min read length = 35) by cutadapt 3.1: 
`cutadapt -m 35 -q 20,20`

The clean reads are available in `/data/projects/rob/data/raw_fastq_2019` on iTrop,
and `/shared/projects/elai_most/data/fastq/fastq_2019_clean` on IFB.

```{r}
sum_fastqc <- function(stat_file) {
  all_stats <- read.delim(stat_file)
  
  min_read_length <- all_stats %>% 
    pull(FastQC_mqc.generalstats.fastqc.avg_sequence_length) %>% 
    min()
  max_read_length <- all_stats %>% 
    pull(FastQC_mqc.generalstats.fastqc.avg_sequence_length) %>% 
    max()
  
  min_num_seq <- all_stats %>% 
    pull(FastQC_mqc.generalstats.fastqc.total_sequences) %>% 
    min()
  max_num_seq <- all_stats %>% 
    pull(FastQC_mqc.generalstats.fastqc.total_sequences) %>% 
    max()
  
  min_cov <- all_stats %>% 
    mutate(coverage = FastQC_mqc.generalstats.fastqc.total_sequences*2*FastQC_mqc.generalstats.fastqc.avg_sequence_length/750000000) %>% 
    pull(coverage) %>% min
  max_cov <- all_stats %>% 
    mutate(coverage = FastQC_mqc.generalstats.fastqc.total_sequences*2*FastQC_mqc.generalstats.fastqc.avg_sequence_length/750000000) %>% 
    pull(coverage) %>% max
  
  cat("- Read length:", min_read_length, "-", max_read_length, "\n")
  cat("- Number of sequences:", min_num_seq*2, "-", max_num_seq*2, "\n")
  cat("- Coverage:", min_cov, "-", max_cov, "\n")
}
```


```{r}
sum_fastqc("/shared/projects/afrob_seq/wgs_snp/vcf_bgi_2021/gbp_output/fastqc/multiqc/fastqc_data/multiqc_general_stats.txt")
```


Clean reads    
- Read length: 88 - 150
- Number of sequences: 76M - 704M   
- Coverage: 10 - 92    
- Base quality: > 25    
- No adapter contamination    

Make a soft link to a seperate folder to run Kiss more easily

```{bash}
kiss_fastq=/shared/projects/most_kmer/kiss_af/fastq
mkdir -p $kiss_fastq
ln -s /shared/projects/elai_most/data/fastq/fastq_2019_clean/[^TR,^S]*/*.f*q.gz $kiss_fastq/
```


## Newly sequenced samples

We selected 5 African samples with more pure genetic structure based on snmf results using kasp SNPs (together with other 15 African + 2 VN samples).    
These samples were degraded (level B or C on BGI quality report, and so some digestion step was skipped).   
Therefore, we need to check carefully the sequecing quality.    
The data is currently stored in `/shared/projects/afrob_seq/fastq_2022` on IFB

```{bash rename_fastq}
fastqfiles=$(ls /shared/projects/afrob_seq/fastq_2022/Reads/Clean/*/*)
newpath=/shared/projects/afrob_seq/fastq_2022/renamed
mkdir $newpath
for f in $fastqfiles
do
    sample=$(echo $(basename $(dirname $f)) | sed 's/A//')
    read=$(echo ${f:(-7)})
    mkdir -p $newpath/$sample
    ln -s $f $newpath/$sample/$sample"_"$read
done
ll $newpath
```

```{bash quality_control}
mkdir -p /shared/projects/afrob_seq/fastq_2022/quality
cd /shared/projects/afrob_seq/fastq_2022/quality
nano qc_config.yaml
nano run_qc.sh
sbatch run_qc.sh
```

```{r}
sum_fastqc("/shared/projects/afrob_seq/fastq_2022/quality/fastqc/fastqc_data/multiqc_general_stats.txt")
```


The reads were preprocessed and cleaned by BGI (22 samples)    
- Read length: 150
- Number of read bases: 44M - 248M   
- Coverage: 9 - 49    
- Base quality: > 25    
- No adapter contamination    



Even though the reads are of good quality, I keep cleaning them in the same way as for the previous data.   
The scripts for cleaning the previous data is [here](/shared/projects/afrob_seq/wgs_snp/vcf_bgi_2021/config/clean_fastq_2019.sh)    


```{bash}
cd ..
mkdir cleaned_reads
cd cleaned_reads
nano clean_fastq.sh
sbatch clean_fastq.sh
```


Check the quality of the cleaned reads

```{bash}
cd ../
mkdir quality_cleaned
cp quality/qc_config.yaml quality_cleaned/
cp quality/run_qc.sh quality_cleaned/
nano quality_cleaned/qc_config.yaml 
nano quality_cleaned/run_qc.sh
sbatch quality_cleaned/run_qc.sh
```

Cleaned reads:
```{r}
sum_fastqc("/shared/projects/afrob_seq/fastq_2022/quality_cleaned/fastqc/fastqc_data/multiqc_general_stats.txt")
```

- Read length: 148.2436 - 149.3562 
- Number of sequences: 44M - 247M
- Coverage: 8.827241 - 49.28375

Make a soft link of 5 new samples to the fastq folder for kiss

```{bash}
kiss_fastq=/shared/projects/most_kmer/kiss_af/fastq
mkdir -p $kiss_fastq
ln -s /shared/projects/afrob_seq/fastq_2022/renamed/[C,D]*/*.f*q.gz $kiss_fastq/
fastq_files=$(ls $kiss_fastq)

# rename the new seqs to have homogenous name format for all the samples
for f in $fastq_files 
do
    if [[ $f =~ fq ]]
    then 
        echo -e "$f"
        sample=$(echo $f | cut -d "_" -f 1)
        read=$(echo $f | cut -d "_" -f 2 | cut -d "." -f 1)
        new_name=$sample"_R"$read".fastq.gz"
        echo -e $new_name
        cd $kiss_fastq
        mv $f $new_name
    fi
done
```


## Climatic data

Climatic data for the African samples was extracted by `climatic_data.Rmd` and stored in `gea/climatic_variables_2.1.csv`


## Extract k-mers and detect k-mers under selection

results in `/shared/projects/most_kmer/kiss_af`  


1,856,279,562 k-mers in total  
410,304,144 k-mers under selection


## LFMM results using only outlier kmers

check if all the runs are done
```{r}
lfmm_out <- "./gea/lfmm/out_K5_outlier"
real <- dirname(list.files(lfmm_out, "candidates_kmers.csv", full.names = F, recursive = T))
length(real)

n <- 1856
expect <- sapply(1:n, function(r) {
  if (r %% 100 == 0) {
    b <- r/100 - 1
    s <- 100
  } else {
    b <- r %/% 100
    s <- r %% 100
  }
  return(paste(b, s, sep = "_"))
})
length(expect)

# files that haven't finished
expect[!expect %in% real]
```

gather all the lfmm results for all the k-mer batches using the log files (faster i think)

```{r}
log_K5 <- "./gea/lfmm/log_K5_outlier"
log_files <- list.files(log_K5, pattern = ".log", full.names = T)
n <- length(log_files)

cand_kmers <- do.call(rbind, lapply(1:n, function(i) {
  cat(i, "\n")
  df <- fread(log_files[i], skip = 12, nrows = 21, sep = "\t", 
              data.table = FALSE)
  df <- df %>% mutate(batch = i)
  return(df)
  })
  )

sum_cand_kmers <- cand_kmers %>% 
  dplyr::group_by(variable) %>% 
  summarise(across(significant_kmers:significant_outliers, ~ sum(.x))) %>% 
  arrange(desc(significant_outliers))

format(as.data.frame(sum_cand_kmers), big.mark = ",")

can_files <- list.files("./gea/lfmm/out_K5_outlier", 
                        pattern = "candidates_kmers.csv", 
                        full.names = T, recursive = T)
can_count <- lapply(can_files, fread)
all_can <- do.call(rbind, can_count)
dim(all_can)
```


    variable significant_kmers significant_outliers
1      bio_2        30,012,712           30,012,712
2      bio_7        27,404,828           27,404,828
3      bio_3         9,000,933            9,000,933
4     bio_15         8,688,835            8,688,835
5     bio_14         2,803,076            2,803,076
6      bio_9         2,052,938            2,052,938
7      bio_1         1,942,297            1,942,297
8      bio_6         1,874,238            1,874,238
9     bio_17         1,844,878            1,844,878
10     bio_5         1,672,097            1,672,097
11    bio_12         1,498,292            1,498,292
12    bio_13         1,435,270            1,435,270
13    bio_11         1,343,750            1,343,750
14     bio_8         1,150,733            1,150,733
15 elevation           909,767              909,767
16     bio_4           645,615              645,615
17    bio_10           508,358              508,358
18    bio_18           355,445              355,445
19    bio_16           174,929              174,929
20    bio_19            34,923               34,923
in total: 48,995,113

```{r}
log_K5_chelsa <- "./gea/lfmm/log_K5_outlier_chelsa/"
log_K5_chelsa_files <- list.files(log_K5_chelsa, pattern = ".log", full.names = T)
n <- length(log_K5_chelsa_files)

cand_kmers_chelsa <- do.call(rbind, lapply(1:n, function(i) {
  cat(i, "\n")
  df <- fread(log_K5_chelsa_files[i], skip = 12, nrows = 21, sep = "\t", 
              data.table = FALSE)
  df <- df %>% mutate(batch = i)
  return(df)
  })
  )

sum_cand_kmers_chelsa <- cand_kmers_chelsa %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise(across(significant_kmers:significant_outliers, ~ sum(.x))) %>% 
  arrange(desc(significant_outliers))

format(as.data.frame(sum_cand_kmers_chelsa), big.mark = ",")

can_files_chelsa <- list.files("./gea/lfmm/out_K5_outlier_chelsa/", 
                        pattern = "candidates_kmers.csv", 
                        full.names = T, recursive = T)
can_count_chelsa <- lapply(can_files_chelsa, fread)
all_can_chelsa <- do.call(rbind, can_count_chelsa)
# number of significant kmers
nrow(all_can_chelsa)
# number of significant outliers
length(all_can_chelsa$sequence[all_can_chelsa$outlier])
```


## LFMM results using all kmers

check if all the runs are done
```{r}
lfmm_out <- "./gea/lfmm/out_K5"
real <- dirname(list.files(lfmm_out, "candidates_kmers.csv", full.names = F, recursive = T))
length(real)

n <- 1856
expect <- sapply(1:n, function(r) {
  if (r %% 100 == 0) {
    b <- r/100 - 1
    s <- 100
  } else {
    b <- r %/% 100
    s <- r %% 100
  }
  return(paste(b, s, sep = "_"))
})
length(expect)

# files that haven't finished
expect[!expect %in% real]
```

gather all the lfmm results for all the k-mer batches using the log files (faster i think)

```{r}
log_K5 <- "./gea/lfmm/log_K5"
log_files <- list.files(log_K5, pattern = ".log", full.names = T)
n <- length(log_files)

cand_kmers <- do.call(rbind, lapply(1:n, function(i) {
  cat(i, "\n")
  df <- fread(log_files[i], skip = 12, nrows = 21, sep = "\t", 
              data.table = FALSE)
  df <- df %>% mutate(batch = i)
  return(df)
  })
  )

sum_cand_kmers <- cand_kmers %>% 
  dplyr::group_by(variable) %>% 
  summarise(across(significant_kmers:significant_outliers, ~ sum(.x))) %>% 
  arrange(desc(significant_outliers))

format(as.data.frame(sum_cand_kmers), big.mark = ",")

can_files <- list.files("./lfmm/out_K5", 
                        pattern = "candidates_kmers.csv", 
                        full.names = T, recursive = T)
can_count <- lapply(can_files, fread)
all_can <- do.call(rbind, can_count)
# number of significant kmers
nrow(all_can)
# number of significant outliers
length(all_can$sequence[all_can$outlier])
```


    variable significant_kmers significant_outliers
1      bio_7        46,295,609           15,209,945
2      bio_2        39,549,887           12,989,670
3      bio_6        24,400,908            8,025,601
4      bio_5        22,509,920            7,403,012
5      bio_3        21,516,670            7,272,921
6     bio_15        21,693,587            7,066,614
7     bio_18         8,244,191            2,901,733
8     bio_12         7,338,038            2,653,891
9     bio_11         6,753,399            1,923,549
10     bio_8         4,433,745            1,534,612
11     bio_1         3,317,872            1,147,873
12    bio_13         2,374,762              957,389
13     bio_9         2,805,126              907,330
14    bio_17         2,199,302              733,119
15    bio_14         1,270,101              501,134
16 elevation         1,394,007              479,655
17     bio_4           981,808              222,915
18    bio_10           107,796               38,276
19    bio_19            36,104                3,483
20    bio_16                 0                    0
105,180,163

-> use significant kmers from output of lfmm on all kmers, because this takes into account both outliers and neutral kmers

## Mapping k-mers to the reference genome

```{r}
map_out <- "/shared/projects/most_kmer/kiss_af/output/10.MERGE_KMERPOSITION/kmer_position_merged.txt"
kmer_pos <- fread(map_out)
kmer_pos <- kmer_pos %>% filter(grepl("CC1.8", REF))
```

the kiss output "/shared/projects/most_kmer/kiss_af" is temporarily saved on node4 in iTrop

count the number of kmers mapped and passed filtering
```{bash}
ssh baotram@bioinfo-master.ird.fr
cd /scratch/most_kmer/kiss_af/output/9.KMERPOSITION
wc -l output_file.*_vs_CC1.8_v2_pseudomolecule_cat_KMERPOSITION.txt
```
-> 586,486,414 kmers

get kmer positions by chromosome
```{bash}
for chr in Contig CC1.8.Chr01 CC1.8.Chr02 CC1.8.Chr03 CC1.8.Chr04 CC1.8.Chr05 CC1.8.Chr06 CC1.8.Chr07 CC1.8.Chr08 CC1.8.Chr09 CC1.8.Chr10 CC1.8.Chr11
do
    echo "$chr"
    grep $chr output_file.*_vs_CC1.8_v2_pseudomolecule_cat_KMERPOSITION.txt | sort -k5 -n > $chr.txt
done
```

merge pvalue from lfmm to kmer positions
```{bash}
rsync -vaurP baotram@core.cluster.france-bioinformatique.fr:/shared/projects/most_kmer/afterkiss/gea/lfmm_rda /scratch/most_kmer
```


## Assembly of associated k-mers using mergeTags

try [mergeTags](https://github.com/Transipedia/dekupl-mergeTags)

install mergeTags
```{bash}
ssh baotram@core.cluster.france-bioinformatique.fr
cd /shared/ifbstor1/projects/most_kmer/afterkiss/gea
mkdir assembly
cd assembly
git clone https://github.com/Transipedia/dekupl-mergeTags.git
cd dekupl-mergeTags
make
```

test mergeTags
```{bash}
mkdir test
cd test
nano merged_lfmm_pvalues.csv
awk '{print $1"\t"$4"\t"$4"\t"$4"\t"$3}' merged_lfmm_pvalues.csv > merged_lfmm_pvalues2mergetags.csv
../dekupl-mergeTags/mergeTags -k 31 -m 15 -n merged_lfmm_pvalues2mergetags.csv > out_merged_lfmm_pvalues2mergetags.csv
```

run mergeTags on the all associated k-mers (with minimum overlap = 15)


```{r}
fwrite(all_can %>% relocate(sequence), 
       "./assembly/significant_kmers_lfmm.tsv", 
       sep = "\t", row.names = F)
```




```{bash}
sbatch /shared/ifbstor1/projects/most_kmer/afterkiss/gea/assembly/mergeTags_assembly.sh
```

### with m 15 (default)
```{r}
mergeTags_out <- "./assembly/mergeTags_significant_kmers_lfmm_m15.tsv"
mT_contigs <- fread(mergeTags_out, data.table = F)
unassembled <- mT_contigs %>% 
  filter(nb_merged_kmers == 1)
contigs <- mT_contigs %>% 
  filter(nb_merged_kmers != 1)
```

-> 856,880 unassembled k-mers
-> 4,804,047 contigs


analyse contigs
```{r}
contigs <- contigs %>% 
  # filter(nb_merged_kmers > 100) %>% 
  mutate(contig_length = str_count(contig))
fwrite(contigs, "./assembly/all_contigs_m15_R.txt")


sum_merged_kmers <- contigs %>% 
  mutate(nb_kmers_ranges = cut(nb_merged_kmers,
                               c(min(contigs$nb_merged_kmers), 500, 
                                 # seq(10, 100, 10),
                                 seq(1000, 8000, 1000), 
                                 max(contigs$nb_merged_kmers)+1),
                               dig.lab = 5,
                               include.lowest = T, right = F)) %>% 
  group_by(nb_kmers_ranges) %>% 
  summarise(nb_contigs = n())

sum_ct_length <- contigs %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(min(contigs$contig_length), 500, #61,
                                      # seq(100, 500, 100),
                                      # 545, 1000, 2000,
                                      seq(1000, 8000, 1000), 
                                      max(contigs$contig_length)+1),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges) %>% 
  summarise(nb_contigs = n())
```

```{r}
sum_merged_kmers %>% 
  mutate(nb_kmers_ranges = gsub("\\[|\\]|\\)", "", nb_kmers_ranges)) %>% 
  mutate(nb_kmers_ranges = gsub(",", "-", nb_kmers_ranges)) %>% 
  rowwise() %>% 
  mutate(nb_kmers_ranges = gsub("-\\d+", 
                                paste0("-", as.numeric(gsub("\\d+-", "", nb_kmers_ranges))-1), 
                                nb_kmers_ranges)) %>% 
  mutate(nb_kmers_ranges = factor(nb_kmers_ranges, nb_kmers_ranges)) %>% 
ggplot(aes(x = nb_kmers_ranges, y = nb_contigs)) + 
  geom_col(width = 0.8) + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Number of merged k-mers per contig") +
  ylab("Number of contigs") + 
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 15))
```


```{r}
sum_ct_length %>% 
  mutate(contig_length_ranges = gsub("\\[|\\]|\\)", "", contig_length_ranges)) %>% 
  mutate(contig_length_ranges = gsub(",", "-", contig_length_ranges)) %>% 
  rowwise() %>% 
  mutate(contig_length_ranges = gsub("-\\d+", 
                                paste0("-", as.numeric(gsub("\\d+-", "", contig_length_ranges))-1), 
                                contig_length_ranges)) %>% 
  mutate(contig_length_ranges = factor(contig_length_ranges, contig_length_ranges)) %>% 
ggplot(aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col(width = 0.8) + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs") + 
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 15))
```

```{r}
# number of contigs associated with each bioclim variables
bio_contigs <- contigs %>% 
  select(bio_1:elevation) %>% 
  summarise(across(everything(), ~ sum(.)))
contigs %>% 
  rowwise() %>% 
  mutate(n_bio = across(bio_1:elevation, ~ sum(.)))
```

```{r}
long_contigs <- contigs %>% 
  filter(contig_length > 500)
long_contigs$contig_id <- paste0("contig_", 1:nrow(long_contigs))
```
-> 9,005 contigs with length > 500nt

```{r}
fwrite(long_contigs, "./assembly/long_contigs_m15_R.txt")
long_contigs <- fread("./assembly/long_contigs_m15_R.txt")
```


```{r}
long_contigs %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(min(long_contigs$contig_length),
                                      seq(100, 500, 100),
                                      545, 1000, 2000,
                                      max(long_contigs$contig_length)),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges) %>% 
  summarise(mean_nb_kmers = mean(nb_merged_kmers)) %>% 
  mutate(mean_nb_kmers = )
  # summarise(nb_contigs = n())
```

```{r}
hist(contigs$nb_merged_kmers, breaks = 1000)
ggplot(contigs %>% filter(nb_merged_kmers > 100)) +
  geom_histogram(aes(x = nb_merged_kmers), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt(breaks = c(0, 10, 100, 1000, 2000, 3000, 4000)) 
min(contigs$nb_merged_kmers)
max(contigs$nb_merged_kmers)


ggplot(contigs) +
  geom_histogram(aes(x = contig_length), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt() 
min(contigs$contig_length)
max(contigs$contig_length)
```


```{r}
long_contigs <- contigs %>% 
  filter(contig_length > 60)

ggplot(long_contigs) +
  geom_histogram(aes(x = nb_merged_kmers), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt(breaks = c(0, 10, 100, 1000, 5000, 10000)) 

ggplot(long_contigs) +
  geom_histogram(aes(x = contig_length), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt()
```

we keep only contigs with length > 400 or 500

```{r}
fin_contigs <- long_contigs %>% 
  filter(contig_length >= 500)
```

```{r}
fwrite(fin_contigs, "./assembly/long_contigs_m15_l500_R.txt")
fin_contigs <- fread("./assembly/long_contigs_m15_l500_R.txt")
```

```{r}
fin_contigs <- contigs %>% 
  filter(contig_length >= 400)
fwrite(fin_contigs, "./assembly/long_contigs_m15_l400_R.txt")
```



```{r}
mergeTags_out_com <- "./assembly/mergeTags_significant_kmers_rda_lfmm_m15.tsv"
mT_contigs_com <- fread(mergeTags_out_com, data.table = F)
unassembled_com <- mT_contigs_com %>% 
  filter(nb_merged_kmers == 1)
contigs_com <- mT_contigs_com %>% 
  filter(nb_merged_kmers != 1)
nrow(unassembled_com)
nrow(contigs_com)
```


### with m 21

```{r contigs_m21}
mergeTags21_out <- "./assembly/mergeTags_significant_kmers_lfmm_m21.tsv"
mT_res_21 <- fread(mergeTags21_out, data.table = F)
# unassembled_m30 <- mT_res_30 %>% 
#   filter(nb_merged_kmers == 1)
contigs_m21 <- mT_res_21 %>% 
  filter(nb_merged_kmers != 1) %>% 
  # filter(nb_merged_kmers > 61) %>% 
  mutate(contig_length = str_count(contig))
nrow(mT_res_21) - nrow(contigs_m21)
```
-> 30,645,634 unassembled kmers
-> 22,767,142 contigs

```{r}
fwrite(contigs_m21, "./assembly/all_contigs_m21_R.txt")
contigs_m21 <- fread("./assembly/all_contigs_m21_R.txt")
```


```{r long_contigs_m21}
long_contigs_m21 <- contigs_m21 %>% 
  filter(contig_length > 60)
long_contigs_m21$contig_id <- paste0("contig_", 1:nrow(long_contigs_m21))
nrow(long_contigs_m21)
```
-> 964,556 contigs >= 61 bp

```{r}
fwrite(long_contigs_m21, file = "./assembly/long_contigs_m21_R.txt")
```

```{r}
fin_contigs_m21 <- contigs_m21 %>% 
  filter(contig_length >= 200)
fwrite(fin_contigs_m21, "./assembly/contigs_m21_l200_R.txt")
```


```{r}
ggplot(contigs_m21) +
  geom_histogram(aes(x = nb_merged_kmers), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt(breaks = c(0, 10, 100, 1000, 2000, 3000, 4000)) 

min(contigs_m21$nb_merged_kmers)
max(contigs_m21$nb_merged_kmers)


ggplot(contigs_m21) +
  geom_histogram(aes(x = contig_length), binwidth = 100) +
  theme_minimal() +
  scale_y_sqrt() 
```


```{r stats_contigs_m21}
contigs_m21 %>% 
  filter(nb_merged_kmers > 30)

sum_merged_kmers_m21 <- contigs_m21 %>% 
  mutate(nb_kmers_ranges = cut(nb_merged_kmers,
                               c(min(contigs_m21$nb_merged_kmers), 
                                 seq(10, 100, 10), 
                                 max(contigs_m21$nb_merged_kmers)),
                               dig.lab = 5,
                               include.lowest = T, right = F)) %>% 
  group_by(nb_kmers_ranges) %>% 
  summarise(nb_contigs = n())

sum_ct_length_m21 <- contigs_m21 %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(min(contigs_m21$contig_length), 61,
                                      seq(100, 500, 100), 
                                      max(contigs_m21$contig_length)),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges) %>% 
  summarise(nb_contigs = n())
```

```{r plot_stats_m21}
ggplot(sum_merged_kmers_m21, aes(x = nb_kmers_ranges, y = nb_contigs)) + 
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Number of merged k-mers per contig") +
  ylab("Number of contigs")

ggplot(sum_ct_length_m21, aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs")

ggplot(sum_ct_length_m21 %>% filter(contig_length_ranges != "[32,61)"), 
       aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs")

ggplot(sum_ct_length %>% filter(contig_length_ranges != "[32,61)"), 
       aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs")

rbind(sum_ct_length %>% mutate(min_overlap = 15),
      sum_ct_length_m21 %>% mutate(min_overlap = 21)) %>% 
  # filter(contig_length_ranges != "[32,61)") %>% 
  ggplot(aes(x = contig_length_ranges, y = nb_contigs)) + 
  facet_grid(cols = vars(paste("min. overlap =", min_overlap)), scale = "free_x", space = "free") +
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  # xlab("Contig length") +
  ylab("Number of contigs") + 
  theme(strip.text = element_text(size = 18),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 18)) 
```


### with m25 
```{r contigs_m25}
mergeTags25_out <- "./assembly/mergeTags_significant_kmers_lfmm_m21.tsv"
mT_res_25 <- fread(mergeTags25_out, data.table = F)
# unassembled_m30 <- mT_res_30 %>% 
#   filter(nb_merged_kmers == 1)
contigs_m25 <- mT_res_25 %>% 
  filter(nb_merged_kmers != 1) %>% 
  # filter(nb_merged_kmers > 61) %>% 
  mutate(contig_length = str_count(contig))
nrow(mT_res_25) - nrow(contigs_m25)
```
-> 30,645,634 unassembled kmers
-> 22,767,142 contigs



```{r long_contigs_m25}
long_contigs_m21 <- contigs_m21 %>% 
  filter(contig_length > 60)
nrow(long_contigs_m21)
```
-> 964,556 contigs >= 61 bp



## Assembly of associated k-mers using abyss

```{r}
kmer_set <- BStringSet(all_can$sequence)
names(kmer_set) <- paste0("kmer_", 1:length(kmer_set))
writeXStringSet(kmer_set, "./assembly/significant_kmers.fasta")
```

## Blast assembled contigs on NR database of Viridiplantae

### write the long contigs to a fasta file
```{r}
fin_contigs$contig_id <- paste0("contig_", 1:nrow(fin_contigs))
contigs4blast <- BStringSet(fin_contigs$contig)
names(contigs4blast) <- fin_contigs$contig_id

writeXStringSet(contigs4blast, "./assembly/contigs_m15_l500.fasta", format = "fasta")
writeXStringSet(contigs4blast, "./assembly/contigs_m15_l400.fasta", format = "fasta")
```

### run blastx on NR database  
with the script `./annotation/blast_nr_contigs_m15_l500_array_ifb.sh`


### analyze blastx results of the contigs  

#### summarize blast results

```{r}
parseblastxml <- function(blastxml) {
  text <- xmlParse(blastxml)
  list <- xmlToList(text)
  df <- data.frame(contig = list$BlastOutput2$report$Report$results$Results$search$Search$`query-title`,
                   contig_length = list$BlastOutput2$report$Report$results$Results$search$Search$`query-len`,
                   bitscore = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$`bit-score`,
                   evalue = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$evalue,
                   align_length = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$`align-len`)
  return(df)
}

blastx_out <- list.files("./annotation/contigs_m15_l500_blastx", "*.xml", full.names = T)
blastx_contigs <- do.call(rbind, lapply(blastx_out, function(b) {
  print(which(blastx_out == b))
  df <- parseblastxml(b)
  # text <- xmlParse(b)
  # list <- xmlToList(text)
  # df <- data.frame(contig = list$BlastOutput2$report$Report$results$Results$search$Search$`query-title`,
  #                  contig_length = list$BlastOutput2$report$Report$results$Results$search$Search$`query-len`,
  #                  bitscore = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$`bit-score`,
  #                  evalue = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$evalue,
  #                  align_length = list$BlastOutput2$report$Report$results$Results$search$Search$hits$Hit$hsps$Hsp$`align-len`)
  return(df)
}))

blastx_contigs_filt <- blastx_contigs %>% 
  filter(as.numeric(evalue) < 1e-6)
hist(as.numeric(blastx_contigs_filt$align_length))
min(as.numeric(blastx_contigs_filt$align_length))
max(as.numeric(blastx_contigs_filt$align_length))
```
-> 1833/3418 (54%) contigs have hits 

#### obtain GO terms by Blast2GO


check if all the sequences are blasted
```{bash}

files=$(ls)

for f in $files
do
	if grep -Fxq "</BlastXML2>" $f
	then 
		continue
	else
		echo $f
	fi
done

grep "Query" CC1.8_v2_batch_718_blastx_besthit.xml | wc -l


for f in $files
do
	lines=$(grep "Query" $f | wc -l)
	if [ $lines == 10 ]
	then 
		continue
	else
		echo $f
	fi
done
```


get GOs of the contigs
```{r}
read_mapping <- function(txtfile) {
  df <- fread(txtfile, sep = "\t", header = F)
  df <- df[,-9]
  df_col <- str_split(read_lines(txtfile, n_max = 1), "\t", simplify = T)
  colnames(df) <- df_col
  return(df)
} 

contigs_go <- read_mapping("./annotation/blast2go_contigs_m15_l500_mapping.txt")
contigs_go <- contigs_go %>% 
  filter(Seq %in% blastx_contigs_filt$contig)
contigs_go %>% pull(Seq) %>% unique %>% length
```
-> 1064/1833 (58%) contigs have GO terms - 7469 GOs


get GOs of the reference (28880 genes)

```{r}
ref_go <- read_mapping("./annotation/blast2go_CC1_8_v2_mapping.txt")
ref_go <- ref_go %>% 
  filter(eValue < 1e-6)
ref_go %>% pull(Seq) %>% unique %>% length

```
-> 18703/28880 (65%) genes have GO terms - 92404 GOs

### GO enrichment

```{r}
blast_out <- "./assembly/blast_contigs_m15_l500_results.txt"
blast_contigs <- fread(blast_out)
colnames(blast_contigs) <- c("contig_id", "mapped_seq", "start", "end", "mapped_start", "mapped_end", "bitscore", "score", "identity", "gaps", "mismatches", "align_length", "contig_length")

blast_contigs %>% 
  filter(score > 100)

length(unique(blast_contigs$contig_id))

blast_contigs %>% 
  # filter(evalue < 0.01) %>% 
  arrange(desc(score))

go_list <- factor(as.numeric(unique(ref_go$GO) %in% contigs_go$GO))
names(go_list) <- 1:length(unique(ref_go$GO))
length(go_list[go_list == 1])
GO2geneID <- as.list(ref_go$Seq)
names(GO2geneID) <- ref_go$GO

geneID2GO <- as.vector(ref_go$GO)
names(geneID2GO) <- 1:nrow(ref_go)

GOdata <- new("topGOdata",
              description = "GO analysis on genomic regions under selection, BP",
              ontology = "BP", # or CC or MF
              allGenes = go_list,
              nodeSize = 5,   # delete categories that have too few genes : in our case, a high number of genes gives similar results with a nodeSize of 5 or of 10 (in the tutorial: values between 5 and 10 give more stable results) 
              annot = annFUN.gene2GO,
              gene2GO = geneID2GO
)

#### Fisher test with Classic algorithm not taking into account the hierarchical link between GOterms
Fisherclassic <- runTest(GOdata, algorithm = "classic", statistic = "fisher")

#returns a table listing the top 20 GO terms found as significantly enriched
Fisherclassic.table<-GenTable(GOdata, classicFisher = Fisherclassic, topNodes=10, numChar = 1e6)
Fisherclassic.table
write.table(Fisherclassic.table, "resultFisherclassic.table.txt" , sep=";", quote=FALSE)

#returns a subgraph induced by the top 4 GO terms found as significantly enriched 
showSigOfNodes(GOdata, score(Fisherclassic), firstSigNodes = 4, useInfo ='all')

#### Fisher test with weight01 algorithm taking into account the hierarchical link between GOterms
FisherWeight01<-runTest(GOdata, algorithm = "weight01", statistic = "fisher")

#returns a table listing the top 50 GO terms found as significantly enriched
FisherWeight01.table<-GenTable(GOdata, Weight01 = FisherWeight01, topNodes=123, numChar = 1e6)
FisherWeight01.table


#returns a subgraph induced by the top 4 GO terms found as significantly enriched 
showSigOfNodes(GOdata, score(FisherWeight01), firstSigNodes = 4, useInfo ='all')


allRes <- GenTable(GOdata, classic = Fisherclassic, weight = FisherWeight01,
         orderBy = "weight", ranksOf = "classic", topNodes = 20, numChar = 1e6)
allRes
```

```{r}
library(GOfuncR)
get_parent_nodes(FisherWeight01.table$GO.ID)
```

```{r GR_blast_m15}
blast_contigs <- blast_contigs %>% 
  filter(!grepl("Contig", mapped_chr))
blast_contigs <- left_join(blast_contigs, fin_contigs, by = "contig_id")
blast_contigs <- blast_contigs %>% 
  mutate(palign = align_length/contig_length)

um_contigs <- fin_contigs %>% 
  mutate(blast = if_else(contig_id %in% unique(blast_contigs$contig_id), "mapped", "unmapped"))


sum_um_length <- um_contigs %>% 
  group_by(blast) %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(min(um_contigs$contig_length),
                                      seq(100, 500, 100),
                                      545, 1000, 2000,
                                      max(um_contigs$contig_length)),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges, blast) %>% 
  summarise(nb_contigs = n())

ggplot(sum_um_length, aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col(aes(fill = blast),
           position = position_dodge2(width = 1, preserve = "single", padding = 0)) + 
  geom_text(aes(color = blast, label = nb_contigs), 
            position = position_dodge2(width = 1, preserve = "single"), vjust = 0) + 
  scale_y_sqrt() +
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs") +
  scale_fill_manual(values = c("#b1e0f2", "gray30")) +
  scale_color_manual(values = c("#b1e0f2", "gray30"))


```

```{r}
fwrite(blast_contigs, "./assembly/blast_contigs_m15_results_R.txt")
blast_contigs <- fread("./assembly/blast_contigs_m15_results_R.txt")
```


```{r}
blast_contigs %>% 
  distinct(align_length, contig_length) %>% 
  ggplot() +
  geom_point(aes(x = contig_length, y = align_length)) + 
  xlab("Contig length") + 
  ylab("Alignment length") + 
  theme_minimal()
```

```{r}
long_contigs %>% 
  filter(!contig_id %in% unique(blast_contigs$contig_id)) %>% 
  pull(contig_length) %>% sum()
```



## for contigs assembled by m21
```{r fasta_contigs_m21}
fin_contigs_m21$contig_id <- paste0("contig_", 1:nrow(fin_contigs_m21))
contigs4blast <- BStringSet(fin_contigs_m21$contig)
names(contigs4blast) <- fin_contigs_m21$contig_id

writeXStringSet(contigs4blast, "./assembly/contigs_m21_l200.fasta", format = "fasta")
```

```{r blast_contigs_m21}
blastm21_out <- "./assembly/contigs_m21_blast_mapped.txt"
blast_contigsm21 <- fread(blastm21_out)
colnames(blast_contigsm21) <- c("contig_id", "mapped_chr", "start", "end", "mapped_start", "mapped_end", "identity", "gaps", "mismatches", "align_length")

sum_hits <- blast_contigsm21 %>% 
  filter(!grepl("Contig", mapped_chr)) %>% 
  group_by(contig_id) %>% 
  summarise(n_hits = n())
# hist(sum_hits)

sum_hits %>% 
  mutate(nb_hits_ranges = cut(n_hits,
                              c(1, 2, max(sum_hits$n_hits)),
                              dig.lab = 5,
                              include.lowest = T, right = F)) %>% 
  group_by(nb_hits_ranges) %>% 
  summarise(nb_contigs = n())
```
-> 402,429 contigs are mapped, 395,531 contigs are mapped to chromosomes
168,842 contigs have 1 hit

```{r GR_blast_m21}
blast_contigsm21 <- blast_contigsm21 %>% 
  filter(!grepl("Contig", mapped_chr))
blast_contigsm21 <- left_join(blast_contigsm21, long_contigs_m21, by = "contig_id")
blast_contigsm21 <- blast_contigsm21 %>% 
  mutate(palign = align_length/contig_length)
```

```{r}
blast_contigsm21 %>% 
  distinct(align_length, contig_length) %>% 
  ggplot() +
  geom_point(aes(x = contig_length, y = align_length)) + 
  xlab("Contig length") + 
  ylab("Alignment length") + 
  theme_minimal()
```


```{r}
fwrite(blast_contigsm21, "./assembly/blast_contigs_m21_results_R.txt")
blast_contigsm21 <- fread("./assembly/blast_contigs_m21_results_R.txt")
```

```{r}
blast_contigsm21 %>% 
  filter(palign == 1) %>% 
  group_by(contig_id) %>% 
  summarise(nb_hits = n()) %>% 
  filter(nb_hits == 1)

nrow(long_contigs_m21) - length(unique(blast_contigsm21$contig_id))
```
395541 mapped, 569015 unmapped

```{r}
um_contigs_m21 <- long_contigs_m21 %>% 
  mutate(blast = if_else(contig_id %in% unique(blast_contigsm21$contig_id), "mapped", "unmapped"))

sum_um_kmers_m21 <- um_contigs_m21 %>% 
  group_by(blast) %>% 
  mutate(nb_kmers_ranges = cut(nb_merged_kmers,
                               c(min(um_contigs_m21$nb_merged_kmers), 
                                 seq(10, 150, 10), 
                                 max(um_contigs_m21$nb_merged_kmers)),
                               dig.lab = 5,
                               include.lowest = T, right = F)) %>% 
  group_by(nb_kmers_ranges, blast) %>% 
  summarise(nb_contigs = n())

sum_um_length_m21 <- um_contigs_m21 %>% 
  group_by(blast) %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(32, min(um_contigs_m21$contig_length), 
                                      seq(100, 500, 100), 
                                      max(um_contigs_m21$contig_length)),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges, blast) %>% 
  summarise(nb_contigs = n())

ggplot(sum_um_kmers_m21, aes(x = nb_kmers_ranges, y = nb_contigs)) + 
  geom_col() + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Number of merged k-mers in contig") +
  ylab("Number of contigs")



ggplot(sum_um_length_m21, aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col(aes(fill = blast),
           position = position_dodge2(width = 1, preserve = "single", padding = 0)) + 
  geom_text(aes(color = blast, label = nb_contigs), 
            position = position_dodge2(width = 1, preserve = "single"), vjust = 0) + 
  scale_y_sqrt() +
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs") +
  scale_fill_manual(values = c("#2f7296", "gray40")) +
  scale_color_manual(values = c("#2f7296", "gray40"))
```

```{r}
long_contigs_m21 %>% 
  filter(!contig_id %in% unique(blast_contigsm21$contig_id)) %>% 
  pull(contig_length) %>% sum
```
-> 46,282,945 nt unmapped

```{r GR_blast_m21}
blast_contigsm21 <- blast_contigsm21 %>% 
  # rowwise() %>% 
  mutate(strand = if_else(mapped_start < mapped_end, "+", "-"),
         mapped_start_cr = if_else(mapped_start < mapped_end, mapped_start, mapped_end),
         mapped_end_cr = if_else(mapped_start < mapped_end, mapped_end, mapped_start))
  

blast_c

contigm21_GR <- GRanges(seqnames = blast_contigsm21$mapped_chr,
                        ranges = IRanges(start = blast_contigsm21$mapped_start_cr,
                                         end = blast_contigsm21$mapped_end_cr),
                        strand = blast_contigsm21$strand)


```

```{r plot_cov_m21}
bam_m21 <- "./assembly/contigs_m21_blast_mapped.bam"

genome_fa <- "/shared/projects/vietcaf/data/reference/CC1.8_v2_pseudomolecule_cat.fa"
genome <- scanFa(genome_fa)
genome <- genome[grepl("Chr", names(genome))] # remove contigs
names(genome) <- gsub(" .+", "", names(genome))
# names(genome) <- gsub("CC1.8.Chr", "Chr ", names(genome))
genome_GR <- GRanges(seqnames = names(genome), ranges = IRanges(start = 1, end = width(genome)))

gkp <- plotKaryotype(genome = genome_GR, plot.type = 6) 
kpPlotCoverage(gkp, data=contigm21_GR)

# gkp <- kpPlotBAMDensity(gkp, data=bam_m21)
```

```{r}
blast_contigsm21 %>% 
  mutate(mapped_start = 1:length(identity))
ggplot(blast_contigsm21) + 
  facet_grid(rows = vars(mapped_chr), scales = "free") +
  geom_segment(aes(x = mapped_start, xend = mapped_end, y = 0, yend = 1), position = position_stack())
```


## annotate contigs > 500 nt (m15)


```{r}
blast_nr <- fread("./annotation/contigs_m15_l500_blastx.tsv")
colnames(blast_nr) <- c("contig_id", "qgi", "start", "end", "sacc", "sgi", "sstart", "send", "bitscore", "score", "evalue", "pident", "gaps", "mismatch", "align_length", "qlen", "staxid", "ssciname", "sblastname", "stitle")
blast_nt_filt <- blast_nr %>% 
  filter(evalue < 1e5, grepl("PREDICTED", title),
         align_length > 100) 
blast_nr %>% 
  filter(align_length > 100, ssciname %in% c("Coffea arabica", "Coffea canephora", "Coffea eugenioides")) %>% 
  pull(ssciname) %>% unique() %>% sort()

blast_nr %>% 
  filter(bitscore > 100)
```





remove duplicated sequences in gff file
```{r}
annot <- import.gff3("./annotation/CC1.8_v2_named_annotation_0.5_BTI.gff3")
uni_annot <- annot[!IRanges::duplicated(annot)]
uni_annot <- uni_annot[uni_annot$type == "gene"]
export.gff3(uni_annot, "./annotation/CC1.8_v2_named_annotation_0.5_BTI_unique.gff3")
```
-> 28880 unique sequences


```{r}
library(XML)
f <- "./annotation/contigs_m15_l500_blastx.tsv"
doc1 <- xmlParse(f)

xml_list <- list.files("./annotation", "contig_\\d+_blastx_besthit.xml", full.names = T)

contigs_blastx <- lapply(str_sort(xml_list, numeric = T), function(f) {
  print(f)
  doc1 <- xmlParse(f)
  hsps <- xmlToDataFrame(xmlChildren(xmlRoot(doc1)[["BlastOutput2"]][["report"]][["Report"]][["results"]][["Results"]][["search"]][["Search"]][["hits"]][["Hit"]][["hsps"]]))
  query <- xmlToDataFrame(xmlChildren(xmlRoot(doc1)[["BlastOutput2"]][["report"]][["Report"]][["results"]][["Results"]][["search"]]))[,1:3]
  subj <- xmlToDataFrame(xmlChildren(xmlRoot(doc1)[["BlastOutput2"]][["report"]][["Report"]][["results"]][["Results"]][["search"]][["Search"]][["hits"]][["Hit"]][["description"]]))[1,]
  cbind(query, hsps, subj)
})


xml_remove(xmlChildren(xmlRoot(doc1)[["BlastOutput2"]][["report"]][["Report"]][["results"]][["Results"]][["search"]][["Search"]][["hits"]][["Hit"]][["hsps"]])[1])
```

## Blast assembled contigs on the reference genome

### run blastn on the reference genome
with the script `./assembly/blastn_contigs.sh`

### analyze blastn results
```{r}
blastn_out <- "./annotation/blast_contigs_m15_l500_CC1_8.tsv"
blastn_contigs <- fread(blastn_out)
colnames(blastn_contigs) <- c("contig", "sacc", "qstart", "qend", "sstart", 
                              "send", "bitscore", "score", "evalue", "pident", 
                              "gaps", "mismatch", "length", "qlen")
## number of contigs have hits
blastn_contigs %>% pull(contig) %>% unique %>% length

## summary of alignment length
ggplot(blastn_contigs) + 
  geom_histogram(aes(x = length), binwidth = 10) + 
  scale_x_continuous(breaks = seq(0, max(blastn_contigs$length), 50)) +
  xlab("Alignment length") +
  scale_y_sqrt() +
  theme_minimal_grid()
min(blastn_contigs$length)

## summary of hits
blastn_sum <- blastn_contigs %>% 
  group_by(contig) %>% 
  summarise(n_hits = n())
hist(blastn_sum$n_hits)
ggplot(blastn_sum) + 
  geom_histogram(aes(x = n_hits), binwidth = 1) + 
  xlab("Number of hits of a contig") +
  scale_x_continuous(breaks = seq(0, max(blastn_contigs$length), 50)) +
  theme_minimal_grid()

blastn_contigs %>% 
  mutate(sacc = gsub("Contig\\d+", "CC1.8.Chr00", sacc)) %>% 
  mutate(chrom = as.factor(as.numeric(gsub("CC1.8.Chr", "", sacc)))) %>% 
  group_by(chrom) %>% 
  summarize(n_hits = n()) %>% 
  ggplot() + 
  geom_col(aes(x = chrom, y = n_hits), width = 0.7) +
  ylab("Number of hits") +
  theme_minimal_grid()
```
-> 237/3418 (7%) contigs have hits


```{r}
blastn_contigs %>% 
  mutate(start = if_else(sstart < send, sstart, send),
         end = if_else(sstart < send, send, sstart),
         strand = if_else(sstart < send, "-", "+"))
contig_hits <- makeGRangesFromDataFrame(
  blastn_contigs %>% 
    mutate(start = if_else(sstart < send, sstart, send),
           end = if_else(sstart < send, send, sstart)), 
  seqnames.field = "sacc",
  keep.extra.columns = T)

ref_genes <- ref_go %>% 
  distinct(Seq) %>% 
  mutate(seqnames = gsub("\\_.+", "", Seq),
         start = gsub("(.+\\_|-.+)", "", Seq),
         end = gsub(".+\\-", "", Seq))

ref_genes_range <- makeGRangesFromDataFrame(ref_genes)
contig_hits_ongene <- contig_hits[contig_hits %over% ref_genes_range]
contig_hits_ongene$contig %>% unique %>% length
contig_hits[overlapsAny(contig_hits, ref_genes_range)]
```

```{r}
blastn_genes_out <- "./annotation/blast_contigs_m15_l500_on_genes.tsv"
blastn_genes_contigs <- fread(blastn_genes_out)
colnames(blastn_genes_contigs) <- c("contig", "sacc", "qstart", "qend", "sstart", 
                              "send", "bitscore", "score", "evalue", "pident", 
                              "gaps", "mismatch", "length", "qlen")
## number of contigs have hits
blastn_genes_contigs %>% pull(contig) %>% unique %>% length
```

### GO enrichment
```{r}
contig_genes <- fread("./annotation/blastn_contigs_m15_l500_CC1.8_v2_results.txt")
colnames(contig_genes) <- c("contig_id", "start", "end", "contig_length", "align_length", "sacc", "sstart", "send", "bitscore", "score", "evalue", "pident", "gaps", "mismatch")
contig_gene_list <- unique(gsub(":", "_", blastn_genes_contigs$sacc))
gene_list <- factor(as.numeric(unique(ref_go$Seq) %in% contig_gene_list))
names(gene_list) <- unique(ref_go$Seq)
length(gene_list[gene_list == 1])
GO2geneID <- as.list(ref_go$Seq)
names(GO2geneID) <- ref_go$GO

geneID2GO <- sapply(names(gene_list), 
                    function(g) ref_go$GO[ref_go$Seq == g],
                    USE.NAMES = T)

GOdata2 <- new("topGOdata",
              description = "GO analysis on genomic regions under selection, BP",
              ontology = "BP", # or CC or MF
              allGenes = gene_list,
              nodeSize = 5,   # delete categories that have too few genes : in our case, a high number of genes gives similar results with a nodeSize of 5 or of 10 (in the tutorial: values between 5 and 10 give more stable results) 
              annot = annFUN.gene2GO,
              gene2GO = geneID2GO
)

#### Fisher test with Classic algorithm not taking into account the hierarchical link between GOterms
Fisherclassic2 <- runTest(GOdata2, algorithm = "classic", statistic = "fisher")

#returns a table listing the top 20 GO terms found as significantly enriched
Fisherclassic.table2<-GenTable(GOdata2, classicFisher = Fisherclassic2, topNodes=10, numChar = 1e6)
Fisherclassic.table2
write.table(Fisherclassic.table2, "resultFisherclassic.table.txt" , sep=";", quote=FALSE)

#returns a subgraph induced by the top 4 GO terms found as significantly enriched 
showSigOfNodes(GOdata2, score(Fisherclassic), firstSigNodes = 4, useInfo ='all')

#### Fisher test with weight01 algorithm taking into account the hierarchical link between GOterms
FisherWeight01_2<-runTest(GOdata2, algorithm = "weight01", statistic = "fisher")

#returns a table listing the top 50 GO terms found as significantly enriched
FisherWeight01.table2<-GenTable(GOdata2, Weight01 = FisherWeight01_2, topNodes=3, numChar = 1e6)
FisherWeight01.table2


#returns a subgraph induced by the top 4 GO terms found as significantly enriched 
showSigOfNodes(GOdata2, score(FisherWeight01_2), firstSigNodes = 4, useInfo ='all')


allRes <- GenTable(GOdata2, classic = Fisherclassic, weight = FisherWeight01_2,
         orderBy = "weight", ranksOf = "classic", topNodes = 20, numChar = 1e6)
allRes
```


```{r}
all_long_contigs <- paste0("contig_", 1:3418)
length(all_long_contigs[!all_long_contigs %in% c(blastx_contigs_filt$contig, 
                                                 blastn_contigs$contig, 
                                                 blastn_genes_contigs$contig)])
```

### compare with Remi's results
```{r}
library(readxl)
remi_snps <- read_xlsx("./annotation/gcb16191-sup-0004-tables2-s3.xlsx", sheet = "candidate SNPs")

remi_snps <- remi_snps %>% 
  filter(chromosome != 0) %>% 
  mutate(chromosome = paste0("CC1.8.Chr", sprintf("%02d", chromosome)))
remi_range <- makeGRangesFromDataFrame(remi_snps, seqnames.field = "chromosome",
                                       start.field = "physical_position",
                                       end.field = "physical_position")
remi_range[remi_range %within% contig_hits]
contig_hits[contig_hits %over% remi_range]
```

## RDA results

```{r}
rda_res <- list.files("./rda/log", "log", full.names = T, recursive = T)
rda_sum <- lapply(rda_res, function(i) {
  nb <- fread(i, skip = 23, nrows = 3, header = F, fill = T, select = 1:2)
  colnames(nb) <- c("method", "nb_kmers")
  nb$method[3] <- "RDA_LFMM"
  nb_list <- as.list(nb$nb_kmers)
  names(nb_list) <- nb$method
  return(nb_list)
})

rda_cand <- sum(sapply(rda_sum, function(r) r$RDA))
lfmm_cand <- sum(sapply(rda_sum, function(r) r$LFMM))
com_cand <- sum(sapply(rda_sum, function(r) r$RDA_LFMM))
com_cand/lfmm_cand
```

## Mapping k-mers on reference genome
First, map all the kmers on the ref by bwa-aln (default)

-> 586,484,414 kmers mapped and filtered by MAPQ10

Then, run the script map_lfmm.sh to merge the position to the pvalue for each kmer  
Test with bio2 first

```{bash}
cd /shared/projects/most_kmer/afterkiss/gea/map_lfmm/
# mkdir bio_cand
# for chr in Contig CC1.8.Chr01 CC1.8.Chr02 CC1.8.Chr03 CC1.8.Chr04 CC1.8.Chr05 CC1.8.Chr06 CC1.8.Chr07 CC1.8.Chr08 CC1.8.Chr09 CC1.8.Chr10 CC1.8.Chr11
# do
#   echo "$chr"
#   cat */pvalue_bio_2_${chr}.tsv | sort -k5 -n > chr_sorted/pvalue_bio_2_${chr}.tsv
# done

cat */pvalue_bio_2_*.tsv | grep TRUE | wc -l > manhattan/pvalue_bio_2_lfmm.tsv

## count number of kmers per chromosome
cd manhattan

for chr in Contig CC1.8.Chr01 CC1.8.Chr02 CC1.8.Chr03 CC1.8.Chr04 CC1.8.Chr05 CC1.8.Chr06 CC1.8.Chr07 CC1.8.Chr08 CC1.8.Chr09 CC1.8.Chr10 CC1.8.Chr11
do
    echo -e "${chr}\t"
    c=0
    for bio in {1..11}
    do
        c=$((c + $(cat pvalue_bio_${bio}_lfmm_rda.tsv | grep ${chr} | wc -l)))
    done
    echo -e "${c}\t"
done
```

```{r}
all_kmers <- fread("/shared/projects/most_kmer/afterkiss/gea/map_lfmm/chr_sorted/pvalue_bio_2_CC1.8.Chr01.tsv")
sign_files <- list.files("/shared/projects/most_kmer/afterkiss/gea/lfmm_rda/", 
                         "matrix_significant_kmers_output_file_\\d+.tsv",
                         full.names = T)
sign_kmer <- unlist(lapply(sign_files, function(f) {
  kmer_list <- colnames(fread(f, nrows = 1))[-1]
  return(kmer_list)
}))
all_kmers$V8 <- all_kmers$V3 %in% sign_kmer
colnames(all_kmers) <- c("batch", "kmer_nb", "kmer_seq", "chrom", "position", "pvalue", "lfmm", "lfmm_rda")


cand_kmers <- all_kmers %>% 
  mutate(pos_range = cut(position,
                         seq(min(all_kmers$position), 
                             max(all_kmers$position),
                             5000),
                         dig.lab = 5,
                         include.lowest = T, right = F)) %>% 
  group_by(pos_range) %>% 
  arrange(pvalue, desc(lfmm_rda), .by_group = T) %>% 
  slice_head(n = 1) %>% 
  mutate(candidate = all(lfmm, lfmm_rda))
cand_kmers <- all_kmers %>% 
  filter(lfmm & lfmm_rda)
write.table(cand_kmers, "/shared/projects/most_kmer/afterkiss/gea/map_lfmm/manhattan/test.tsv", 
            sep = "\t", row.names = F, quote = F)
```

```{r}
chr_sum <- data.frame(chrom = names(genome),
                      center = width(genome)/2 + cumsum(c(0, width(genome)[-11])),
                      cum = cumsum(c(0, width(genome)[-11])))

man_files <- list.files("/shared/projects/most_kmer/afterkiss/gea/map_lfmm/manhattan", 
                        "pvalue_bio_\\d+_lfmm_rda.tsv",
                        full.names = T)
signif_kmer_pos <- do.call(rbind, lapply(man_files, function(f) {
  test_kmer <- fread(f)
  bio <- gsub("pvalue_|_|_lfmm_rda.tsv", "", basename(f))
  cat(bio, "\n")
  test_kmer_cum <- full_join(test_kmer, chr_sum, by = "chrom") %>% 
    mutate(position = position + cum) %>% 
    mutate(bioclim = bio)
  return(test_kmer_cum)
}))
signif_kmer_pos <- signif_kmer_pos %>% 
  mutate(bioclim = factor(bioclim, str_sort(unique(signif_kmer_pos$bioclim), numeric = T)))

## number of kmers associated with each bioclim var that are mapped on chromosomes
signif_kmer_pos %>% 
  group_by(bioclim) %>% 
  summarise(nb_kmer = n())
## number of total significant kmers that are mapped on chromosomes
length(unique(signif_kmer_pos$kmer_seq)) # 4792792

pdf("./map_lfmm/manhattan/plot_bio1-bio11.pdf")
ggplot(signif_kmer_pos %>% filter(grepl("bio[1-9][0-1]{0,1}$", bioclim)), aes(x = position, y = -log10(pvalue))) + 
  facet_wrap(vars(bioclim), scales = "fixed", ncol = 1) +
  # geom_point(alpha = chrom), color = "#f28888", size = 1) +
  geom_point(aes(color = chrom), size = .1) +
  geom_vline(data = chr_sum[-1,], aes(xintercept = cum), 
             color = "gray80", linetype = "dashed") +
  # scale_alpha_manual(values = rep(c(1, .5), 6 )) +
  scale_color_manual(values = rep(c("#db6969", "#e8a0a0"), 11 )) +
  # scale_color_manual(values = rep(c("#4e8fcf", "#84b3e0"), 11 )) +
  scale_x_continuous(label = c(rep("", 11), gsub("CC1.8.Chr", "", chr_sum$chrom)), 
                     breaks = c(chr_sum$cum, chr_sum$center),
                     expand = c(0, 0)) +
  xlab("Chromosome") +
  scale_y_continuous(expand = c(0, 0)) +     # remove space between plot area and x axis
  # scale_x_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme( 
    legend.position = "none",
    panel.border = element_blank(),
    # axis.line.x = element_line(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 12),
    strip.background = element_rect(color = NA),
    axis.text = element_text(size = 10)
    )
dev.off()


ggplot(signif_kmer_pos %>% filter(grepl("bio1[2-9]$", bioclim)), aes(x = position, y = -log10(pvalue))) + 
  facet_wrap(vars(bioclim), scales = "fixed", ncol = 1) +
  # geom_point(alpha = chrom), color = "#f28888", size = 1) +
  geom_point(aes(color = chrom), size = .1) +
  geom_vline(data = chr_sum[-1,], aes(xintercept = cum), 
             color = "gray80", linetype = "dashed") +
  # scale_alpha_manual(values = rep(c(1, .5), 6 )) +
  # scale_color_manual(values = rep(c("#db6969", "#e8a0a0"), 11 )) +
  scale_color_manual(values = rep(c("#4e8fcf", "#84b3e0"), 11 )) +
  scale_x_continuous(label = c(rep("", 11), gsub("CC1.8.Chr", "", chr_sum$chrom)), 
                     breaks = c(chr_sum$cum, chr_sum$center),
                     expand = c(0, 0)) +
  xlab("Chromosome") +
  scale_y_continuous(expand = c(0, 0)) +     # remove space between plot area and x axis
  # scale_x_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme( 
    legend.position = "none",
    panel.border = element_blank(),
    # axis.line.x = element_line(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text = element_text(size = 12),
    strip.background = element_rect(color = NA)
    )
```


## Assembly of the adaptive kmers detected by both RDA and LFMM

```{r}
mergeTags_out <- "./assembly/mergeTags_significant_lfmm_rda.tsv"
signif_contigs <- fread(mergeTags_out, data.table = F)
unassembled <- signif_contigs %>% 
  filter(nb_merged_kmers == 1)
contigs <- signif_contigs %>% 
  filter(nb_merged_kmers != 1)
contigs <- contigs %>% 
  # filter(nb_merged_kmers > 100) %>% 
  mutate(contig_length = str_count(contig))
nrow(unassembled)
nrow(contigs)
```

-> 507029 unassembled
-> 1,702,000 contigs

Distribution of contig lengths
```{r}
sum_ct_length <- contigs %>% 
  mutate(contig_length_ranges = cut(contig_length, 
                                    c(min(contigs$contig_length), #61,
                                      # seq(100, 500, 100),
                                      # 545, 1000, 2000,
                                      seq(100, 800, 100), 
                                      max(contigs$contig_length)+1),
                                    dig.lab = 5,
                                    include.lowest = T, right = F)) %>% 
  group_by(contig_length_ranges) %>% 
  summarise(nb_contigs = n())


sum_ct_length %>% 
  mutate(contig_length_ranges = gsub("\\[|\\]|\\)", "", contig_length_ranges)) %>% 
  mutate(contig_length_ranges = gsub(",", "-", contig_length_ranges)) %>% 
  rowwise() %>% 
  mutate(contig_length_ranges = gsub("-\\d+", 
                                paste0("-", as.numeric(gsub("\\d+-", "", contig_length_ranges))-1), 
                                contig_length_ranges)) %>% 
  mutate(contig_length_ranges = factor(contig_length_ranges, contig_length_ranges)) %>% 
ggplot(aes(x = contig_length_ranges, y = nb_contigs)) + 
  geom_col(width = 0.8) + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Contig length") +
  ylab("Number of contigs") + 
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 15))
```


Number of merged kmers in each contig
```{r}
sum_merged_kmers <- contigs %>% 
  mutate(nb_kmers_ranges = cut(nb_merged_kmers,
                               c(min(contigs$nb_merged_kmers), 
                                 # seq(10, 100, 10),
                                 seq(100, 800, 100), 
                                 max(contigs$nb_merged_kmers)+1),
                               dig.lab = 5,
                               include.lowest = T, right = F)) %>% 
  group_by(nb_kmers_ranges) %>% 
  summarise(nb_contigs = n())

sum_merged_kmers %>% 
  mutate(nb_kmers_ranges = gsub("\\[|\\]|\\)", "", nb_kmers_ranges)) %>% 
  mutate(nb_kmers_ranges = gsub(",", "-", nb_kmers_ranges)) %>% 
  rowwise() %>% 
  mutate(nb_kmers_ranges = gsub("-\\d+", 
                                paste0("-", as.numeric(gsub("\\d+-", "", nb_kmers_ranges))-1), 
                                nb_kmers_ranges)) %>% 
  mutate(nb_kmers_ranges = factor(nb_kmers_ranges, nb_kmers_ranges)) %>% 
ggplot(aes(x = nb_kmers_ranges, y = nb_contigs)) + 
  geom_col(width = 0.8) + 
  geom_text(aes(label = nb_contigs), vjust = -1) + 
  scale_y_sqrt() + 
  theme_minimal() +
  xlab("Number of merged k-mers per contig") +
  ylab("Number of contigs") + 
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.title = element_text(size = 15))
```

## Annotate contigs >= 400nt
```{r}
long_contigs <- contigs %>% 
  filter(contig_length >= 400)
```
-> 115 contigs

```{r}
long_contigs$contig_id <- paste0("contig_", 1:nrow(long_contigs))
contigs4blast <- BStringSet(long_contigs$contig)
names(contigs4blast) <- long_contigs$contig_id

writeXStringSet(contigs4blast, "./assembly/contigs_common_l400.fasta", format = "fasta")
```

-> 45 contigs have hit, 14 have GO terms


```{r}
blast_contig <- fread("./annotation/blastx/blast_nr_contigs_common_l400_besthit.tsv")
colnames(blast_contig) <- c("SeqName", "qgi", "qstart", "qend", "sacc", "sgi", "sstart", "send", "bitscore", "score", "evalue", "pident", "gaps", "mismatch", "AlignLength", "SeqLength", "staxid", "SubjectName", "sblastname", "stitle")
b2g_contig <- fread("./annotation/blast2go_contigs_common_mapping_table.tsv")
b2g_res <- left_join(b2g_contig %>% dplyr::select("SeqName", "Description", "sim mean", "GO IDs", "GO Names") %>% filter(`GO IDs` != ""),
           blast_contig %>% dplyr::select("SeqName", "AlignLength", "SeqLength", "SubjectName")
           )
write_delim(b2g_res, "./annotation/blast2go_contigs_common_mapping_table_full.tsv")
```

