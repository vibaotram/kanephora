---
title: "kmer analysis"
author: "Tram"
date: "6/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(BEDMatrix)
library(readr)
library(LEA)
library(vcfR)
library(tidyverse)
library(data.table)
library(lfmm)
library(psych)
library(car)
library(GGally)
library(viridis)
library(vegan)
library(ggfortify)
library(qvalue)
library(Rsamtools)
```

```{r, eval=FALSE}
setwd("/data/projects/rob/scripts/kmer")
setwd("/shared/projects/most_kmer/afterkiss/")
```

`k-mers can identify not only almost all associations found by SNPs and short indels but also SVs and variants in sequences not present in reference genomes`

# Objectives:

1.  detect k-mers under selection (associated with population structure)
2.  detect k-mers associated to local climate

# Methods:

1.  run Kiss on the african set (55 inds) -> confirm genetic structure with SNPs using snmf

2.  run Kiss on the whole set (55 AF + 45 VN) -> select k-mers using 2 statistical methods

3.  GEA

## Test Kiss on the african set


### On I-trop

I had to run it on /scratch, and the results were automatically deleted after few weeks...

```{bash}
sbatch /data/projects/rob/scripts/kiss_scripts/af_kiss_ci2.sh
```

first I tried pcadapt with K=2\
then I found from the scree plot that K = 7 should be a better value\
because it is the largest value before plateau and it is congruent with the cross entropy evaluation by snmf


### On IFB

```{bash}
# transfer fastq data 
cd /shared/projects/most_kmer/
mkdir -p kiss_af/fastq
cd kiss_af
rsync -vauP baotram@bioinfo-nas2.ird.fr:/data/projects/rob/data/raw_fastq_2019/* fastq/
```


### choose a random k-mer set

```{r}
set.seed(123)
rand_set <- sample(1:1728, 1) # 415
bed_nb <- rand_set %/% 100 # 4
range_nb <- rand_set %% 100 # 15

scratch_dir <- "/scratch/kmer/af_kiss/results_ci2"
# kiss_dir <- "./tmp/af_ci2"
kiss_dir <- "/shared/projects/most_kmer/kiss_af/output"
```

-> batch 4, subset 15

### download the corresponding bed file and kmer list file from /scratch

```{bash}
ssh node25
rsync -vaurRP /scratch/kmer/af_kiss/results_ci2/./3.TABLE2BED/output_file.4.* /data/projects/rob/scripts/kmer/tmp/af_ci2
rsync -vaurRP  /scratch/kmer/af_kiss/results_ci2/./5.RANGES/output_file.4/15.txt /data/projects/rob/scripts/kmer/tmp/af_ci2
rsync -vaurRP  /scratch/kmer/af_kiss/results_ci2/./6.PCADAPT/output_file.4_15_BH0.05.pcadapt.rplot.pdf /data/projects/rob/scripts/kmer/tmp/af_ci2
```

### read the files

```{r}
bed_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bed")
matrix <- BEDMatrix(bed_file, simple_names = T)

# bim_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bim")
# bim <- read_delim(bim_file, delim = "\t", col_names = F)

kmer_file <- file.path(kiss_dir, "5.RANGES/output_file.4/15.txt")
kl <- scan(kmer_file)

kmer_names_list <- sort(kl) # kmer number by segment
submat <- matrix[, sort(kl)]

af_sample <- fread("/shared/projects/most_kmer/kiss_af/samples/af_sample_name.txt",
                   data.table = F)

af_sample_file <- "/shared/projects/most_kmer/kiss_af/samples/af_sample_name.txt"
af_sample <- read.delim(af_sample_file)

af_kiss_file <- "/shared/projects/most_kmer/kiss_af/samples/af_sample.txt"
af_kiss <- read.delim(af_kiss_file)

af_sample <- left_join(af_kiss %>% select(accession_id), af_sample)
```

### run snmf on the randomly selected kmer set

```{r}
## SNMF
snmf_dir <- file.path(".", "snmf")
dir.create(snmf_dir, showWarnings = F)
geno_file <- file.path(snmf_dir, "kmer.geno")
write.geno(submat, geno_file)

snmf_kmer <- snmf(geno_file, K = 1:10, CPU = 2, repetitions = 10, project = "new", entropy = T, seed = 987654321)
snmf_kmer <- load.snmfProject(file.path(snmf_dir, "kmer.snmfProject"))
plot(snmf_kmer, pch = 16)

## best k = 5
## choose best run based on cross entropy
k <- 5
best_run <- which.min(cross.entropy(snmf_kmer, K = k))

## plot ancestry proportion
ind_order_kmer <- LEA::barchart(snmf_kmer, K = k, run = best_run, plot = F)
kmer_ref_prop <- as.data.frame(Q(snmf_kmer, K = k, run = best_run))
kmer_ref_prop$Label <- paste(af_sample$accession_id, af_sample$phenotype_value, sep = "_")
kmer_ref_prop$prior <- factor(af_sample$phenotype_value, levels = c("ER", "OB", "C", "AG", "D"))
kmer_ref_prop <- pivot_longer(kmer_ref_prop, cols = V1:V5, names_to = "ancestry", values_to = "proportion")
## rename ancestry
repre <- kmer_ref_prop %>% group_by(ancestry) %>% arrange(desc(proportion)) %>% slice_head(n = 1) %>% slice_tail(n = 1)
# rename_ancestr <- sapply(repre$ancestry, function(i) af_sample$phenotype_value[af_sample$accession_id == repre$Label[repre$ancestry == i]])
# levels(prop$ancestry) <- repre$prior

kmer_ref_prop$Label <- factor(kmer_ref_prop$Label, levels = unique(kmer_ref_prop$Label)[ind_order_kmer$order], ordered = F)
kmer_ref_prop$ancestry <- sapply(kmer_ref_prop$ancestry, function(i) repre$prior[repre$ancestry == i], USE.NAMES = F)

ggplot(kmer_ref_prop) +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = .95, size = 0) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = turbo(5)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, size = 10, hjust = 1),
    axis.title.y = element_text(size = 12),
    # axis.title.x = element_blank(),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(2, "mm"),
    # strip.text.x = element_text(angle = 90, size = 10, hjust = 1)
    ) 
```

```{r}
snmf_group <- kmer_ref_prop %>% 
  group_by(Label) %>% 
  slice_max(proportion) %>% 
  mutate(group = if_else(proportion > 0.7, as.character(ancestry), "hybrid"))

snmf_group %>% 
  group_by(group) %>% 
  summarise(n = n())

write.csv(snmf_group %>% 
            mutate(Label = gsub("\\_\\D{1,2}", "", Label)), 
          "af_samples_ancestry_kmers.csv",
          row.names = F, quote = F)
```


```{r}
k <- 6
best_run <- which.min(cross.entropy(snmf_kmer, K = k))

## plot ancestry proportion
ind_order <- LEA::barchart(snmf_kmer, K = k, run = best_run, plot = F)
kmer_ref_prop <- as.data.frame(Q(snmf_kmer, K = k, run = best_run))
kmer_ref_prop$Label <- paste(af_sample$accession_id, af_sample$label, sep = "_")
kmer_ref_prop$Label <- factor(kmer_ref_prop$Label, levels = unique(kmer_ref_prop$Label)[ind_order$order], ordered = F)
kmer_ref_prop <- pivot_longer(kmer_ref_prop, cols = V1:V6, names_to = "ancestry", values_to = "proportion")

ggplot(kmer_ref_prop) +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = .95, size = 0) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = turbo(7)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, size = 10, hjust = 1),
    axis.title.y = element_text(size = 12),
    # axis.title.x = element_blank(),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(2, "mm"),
    # strip.text.x = element_text(angle = 90, size = 10, hjust = 1)
    ) 
```

### run snmf on window-based SNPs

```{bash}
rsync -vaurP baotram@core.cluster.france-bioinformatique.fr:/shared/projects/most_kmer/vcf_bgi_2021/gbp_output/filtered_vcf_by_chrom/all_final_thin5000_maf002.recode.vcf /data/projects/rob/scripts/kmer/tmp

rsync -vaurP /scratch/kmer/all_kiss/6.PCADAPT/output_file.10_3_BH0.05.pcadapt.rplot.pdf  /data/projects/rob/scripts/kmer/tmp/all

cd /shared/projects/afrob_seq/wgs_snp/vcf_bgi_2021/gbp_output/filtered_vcf_by_chrom
module load vcftools/0.1.16
vcftools \
--vcf af_final_maf005_thin5k_60inds.recode.vcf \
--012

```

```{r}
vcf_file <- "/data/projects/rob/scripts/kmer/tmp/all_final_thin5000_maf002.recode.vcf"
vcf_file <- "/shared/projects/afrob_seq/wgs_snp/vcf_bgi_2021/gbp_output/filtered_vcf_by_chrom/af_final_maf005_thin5k_60inds.recode.vcf"
vcf_header <- scanBcfHeader(vcf_file)
ind_names <- vcf_header[[1]]@listData$Sample
ref_names <- grep("(S-|TR)", ind_names, invert = T, value = T)
ref_names <- sapply(ref_names, function(i) {
  r <- ifelse(grepl("NoIndex", i),
         gsub("(^C|_.+)", "", i),
         gsub("_.+", "", i)
         )
  # r <- gsub("_.+", "", i)
  # return(r)
  id <- grep(r, af_sample$accession_id, value = T)
  prior <- af_sample$phenotype_value[af_sample$accession_id == id]
  return(paste(id, prior, sep = "_"))
}, USE.NAMES = F)
```



```{r}
snp_snmf <- load.snmfProject("/data/projects/rob/data/most_elai/snmf/thin_ref.snmfProject")
snp_snmf <- load.snmfProject("/shared/projects/elai_most/diversity_wasi/seq_analysis/snmf_60inds/thin_ref.snmfProject")
ind_order_snp <- LEA::barchart(snp_snmf, K = 5, run = which.min(cross.entropy(snp_snmf, K = 5)), plot = F)
snp_ref_prop <- as.data.frame(Q(snp_snmf, K = 5, run = which.min(cross.entropy(snp_snmf, K = 5))))
snp_ref_prop$Label <- ref_names
snp_ref_prop$prior <- factor(gsub(".+_", "", ref_names), levels = c("ER", "OB", "C", "AG", "D"))
snp_ref_prop <- pivot_longer(snp_ref_prop, cols = V1:V5, names_to = "ancestry", values_to = "proportion")
## rename ancestry
repre_snp <- snp_ref_prop %>% group_by(ancestry) %>% arrange(desc(proportion)) %>% slice_head(n = 1) %>% slice_tail(n = 1)
# rename_ancestr <- sapply(repre$ancestry, function(i) af_sample$phenotype_value[af_sample$accession_id == repre$Label[repre$ancestry == i]])
# levels(prop$ancestry) <- repre$prior

snp_ref_prop$Label <- factor(snp_ref_prop$Label, levels = unique(snp_ref_prop$Label)[ind_order_snp$order], ordered = F)
snp_ref_prop$ancestry <- sapply(snp_ref_prop$ancestry, function(i) repre_snp$prior[repre_snp$ancestry == i], USE.NAMES = F)

ggplot(snp_ref_prop) +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = .95, size = 0) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = turbo(5)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, size = 10, hjust = 1),
    axis.title.y = element_text(size = 12),
    # axis.title.x = element_blank(),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(2, "mm"),
    # strip.text.x = element_text(angle = 90, size = 10, hjust = 1)
    ) 
```

assign ancestry
```{r}
snp_ref_prop %>%
  group_by(Label) %>% 
  slice_max(proportion) %>% 
  mutate(assign = if_else(proportion > 0.7, as.character(ancestry), "hybrid")) %>% 
  dplyr::select(Label, assign) %>%
  # write.csv(., "offset/af_samples_ancestry_common_remi.csv", quote = F,
  #           col.names = T, row.names = F)
  # group_by(assign) %>%
  # summarise(n = n())
  left_join(snp_ref_prop, ., by = "Label") %>%
  pivot_wider(names_from = ancestry, values_from = proportion) %>% 
  mutate(Label = gsub("_\\D{1,2}$", "", Label)) %>% 
  write.csv(., "af_samples_ancestry.csv", quote = F,
            col.names = T, row.names = F)
```


### compare snmf results of 1M kmers and the snps set

```{r}
both_prop <- full_join(kmer_ref_prop %>% mutate(type = "1M KMER"),
          snp_ref_prop %>% mutate(type = "100K SNP"))
both_prop <- both_prop %>% 
  mutate(Label = factor(Label, levels = rev(unique(snp_ref_prop$Label)[ind_order_snp$order])))

ref_ord <- both_prop %>% 
  group_by(ancestry) %>% 
  mutate(group)
  group_by(group) %>% 
  filter(ancestry == group) %>% 
  mutate(group = factor(group, levels = c("D", "C", "AG", "ER"))) %>% 
  arrange(group, desc(proportion)) %>% 
  pull(Label)
pdf("/data/projects/rob/data/kmers/plots/structure_check.pdf", width = 15, height = 8)
tiff("/shared/projects/most_kmer/paper_plot/structure_ref.tiff",
     width = 10, height = 6, units = "in", res = 1200)
ggplot(both_prop) +
  facet_grid(rows = vars(type)) +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = 0.95, size = 0) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = turbo(5)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  xlab("Individual") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(4, "mm"),
    strip.text.y = element_text(angle = -90, size = 15, hjust = 0.5)
    ) 
dev.off()
```

```{r}
kmer_snp_cor <- full_join(kmer_ref_prop %>% dplyr::rename(kmer = proportion),
          snp_ref_prop %>% dplyr::rename(snp = proportion))

cor.test(kmer_snp_cor$kmer, kmer_snp_cor$snp)
```

-> very high correlation

### run pca on the snp set

```{r}
af_snp_geno_file <- "/data/projects/rob/data/most_elai/snmf/thin_ref.geno"
af_snp_geno_file <- "/shared/projects/most_kmer/afterkiss/snmf/thin_ref.geno"
af_snp_pca <- LEA::pca(af_snp_geno_file)
af_snp_proj <- as.data.frame(af_snp_pca$projections[,1:2])
af_snp_proj$accession_id <- gsub("_.{1,2}$", "", ref_names)
af_snp_proj <- left_join(af_snp_proj, af_sample)
colnames(af_snp_proj)[1:2] <- c("PC1", "PC2")
af_snp_eigen <- af_snp_pca$eigenvalues[,1]
af_snp_proj$label <- factor(af_snp_proj$label, levels = c("A", "B", "C", "D", "E", "G", "O", "R", "hb"))

pdf("/data/projects/rob/data/kmers/plots/af_pca_100kSNPs.pdf")
ggplot(af_snp_proj) +
  # geom_point(aes(x = PC1, y = PC2, color = group), alpha = .5) +
  geom_text(aes(x = PC1, y = PC2, label = label, color = label), show.legend = F, size = 6) +
  xlab(paste0("PC1 (", format(af_snp_eigen[1]/sum(af_snp_eigen)*100, digits = 2), "%)")) +
  ylab(paste0("PC2 (", format(af_snp_eigen[2]/sum(af_snp_eigen)*100, digits = 2), "%)"))  +
  theme_minimal() +
  theme(axis.title = element_text(size = 15), panel.border = element_rect(color = "gray", fill = NA))
dev.off()
```

## Kiss on the whole set

### pca on the snp set

```{r}
ind_names <- sapply(ind_names, function(i) {
    r <- ifelse(grepl("NoIndex", i),
                gsub("(^C|_.+)", "", i),
                gsub("_.+", "", i)
    )
    # r <- gsub("_.+", "", i)
    # return(r)
    id <- grep(r, sample$accession_id, value = T)
    # prior <- sample$phenotype_value[sample$accession_id == id]
    return(id)
}, USE.NAMES = F)
```

```{r}
snp_geno_file <- "/data/projects/rob/data/most_elai/snmf/thin_all.geno"
snp_pca <- pca(snp_geno_file)
snp_proj <- as.data.frame(snp_pca$projections[,1:2])
snp_proj$accession_id <- ind_names
snp_proj <- left_join(snp_proj, sample) %>% 
  rename(PC1 = V1, PC2 = V2) %>% 
  mutate(prior = gsub("(S-|TR)", NA, label))
snp_eigen <- snp_pca$eigenvalues[,1]
snp_proj$prior <- factor(snp_proj$prior, levels = c("A", "B", "C", "D", "E", "G", "O", "R", "hb", NA))


pdf("/data/projects/rob/data/kmers/plots/all_pca_100kSNPs.pdf")
ggplot(snp_proj[nrow(snp_proj):1,]) +
  # geom_point(aes(x = PC1, y = PC2, color = group), alpha = .5) +
  geom_text(aes(x = PC1, y = PC2, label = label, color = prior), show.legend = F, size = 6) +
  xlab(paste0("PC1 (", format(snp_eigen[1]/sum(snp_eigen)*100, digits = 2), "%)")) +
  ylab(paste0("PC2 (", format(snp_eigen[2]/sum(snp_eigen)*100, digits = 2), "%)"))  +
  theme_minimal() +
  theme(axis.title = element_text(size = 15), panel.border = element_rect(color = "gray", fill = NA))
dev.off()
```

-> 399,265,658 adaptive k-mers (K = 7)


### snmf on the whole k-mer set
```{r}
kiss_dir <- "/shared/projects/most_kmer/kiss_all/output/"
bed_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bed")
matrix <- BEDMatrix(bed_file, simple_names = T)

# bim_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bim")
# bim <- read_delim(bim_file, delim = "\t", col_names = F)

kmer_file <- file.path(kiss_dir, "5.RANGES/output_file.4/15.txt")
kl <- scan(kmer_file)

kmer_names_list <- sort(kl) # kmer number by segment
submat <- matrix[, sort(kl)]


all_sample_file <- "/shared/projects/most_kmer/kiss_all/samples/all_sample_name.txt"
all_sample <- read.delim(all_sample_file)

all_kiss_file <- "/shared/projects/most_kmer/kiss_all/samples/all_sample.txt"
all_kiss <- read.delim(all_kiss_file)

all_sample <- left_join(all_kiss %>% select(accession_id), all_sample)

## SNMF
snmf_dir <- file.path(".", "snmf")
dir.create(snmf_dir, showWarnings = F)
geno_file <- file.path(snmf_dir, "all_kmer.geno")
write.geno(submat, geno_file)

all_snmf_kmer <- snmf(geno_file, K = 1:10, CPU = 54, repetitions = 10, project = "new", entropy = T, seed = 987654321)
all_snmf_kmer <- load.snmfProject("./snmf/all_kmer.snmfProject")
plot(all_snmf_kmer)
```

```{r}
## best k = 5
## choose best run based on cross entropy
k <- 3
kmer_all_prop <- as.data.frame(Q(all_snmf_kmer, K = k, run = best_run))
kmer_all_prop$Label <- paste(all_sample$accession_id, all_sample$phenotype_value, sep = "_")
kmer_all_prop$prior <- factor(all_sample$phenotype_value, levels = c("ER", "OB", "C", "AG", "D"))
kmer_all_prop <- pivot_longer(kmer_all_prop, cols = V1:V3, names_to = "ancestry", values_to = "proportion")
## rename ancestry
all_repre <- kmer_all_prop %>% 
  filter(!is.na(prior) | Label == "S-63_NA") %>%
  group_by(ancestry) %>% 
  # slice_max(proportion)
  arrange(desc(proportion)) %>% 
  slice_head(n = 2) %>% 
  slice_tail(n = 1)
# rename_ancestr <- sapply(repre$ancestry, function(i) af_sample$phenotype_value[af_sample$accession_id == repre$Label[repre$ancestry == i]])
# levels(prop$ancestry) <- repre$prior

kmer_all_prop$Label <- factor(kmer_all_prop$Label, levels = unique(kmer_all_prop$Label)[ind_order$order], ordered = F)
kmer_all_prop$ancestry <- sapply(kmer_all_prop$ancestry, function(i) all_repre$prior[all_repre$ancestry == i], USE.NAMES = F)

kmer_all_prop <- kmer_all_prop %>% 
  mutate(group = if_else(is.na(as.character(prior)), "Vietnam", "Africa")) %>% 
  mutate(ancestry = factor(ancestry, levels = c("C", "AG", "D", "OB", "ER", NA)))

ggplot(kmer_all_prop %>% 
         mutate(ancestry = if_else(is.na(ancestry), "NA", as.character(ancestry))) %>% 
         mutate(ancestry = factor(ancestry, c("AG", "C", "D", "ER", "OB", "NA")))) +
  facet_grid(cols = vars(group), scale = "free", space = "free") +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = 1, size = 0) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = c(group_col[1:5], "NA" = "gray")) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  xlab("Individual") +
  theme_minimal() +
  theme(
    # axis.text.x = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.title = element_text(size = 14),
    strip.text = element_text(size = 14),
    # axis.title.x = element_blank(),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(2, "mm"),
    # strip.text.x = element_text(angle = 90, size = 10, hjust = 1)
    ) 
```


```{r}
snp_all_snmf <- load.snmfProject("/shared/projects/elai_most/diversity_wasi/seq_analysis/snmf_60inds/thin_all.snmfProject")

best_k <- 5 #which.min(lapply(1:10, function(i) min(cross.entropy(all_snmf, K = i))))
best_run <- which.min(cross.entropy(snp_all_snmf, K = best_k))
ind_ord <- LEA::barchart(snp_all_snmf, K = best_k, run = best_run, plot = F)
snp_all_prop <- Q(snp_all_snmf, K = best_k, run = best_run)
snp_all_prop <- snp_all_prop %>% 
  as.data.frame() %>% 
  mutate(ind = factor(rownames(df_thin_md), 
                      levels = rownames(df_thin_md)[ind_ord$order])) %>% 
  pivot_longer(cols = -ind, names_to = "ancestry", values_to = "proportion")
snp_all_prop$ancestry <- as.factor(snp_all_prop$ancestry)
levels(snp_all_prop$ancestry) <- c("C", "OB", "ER", "AG", "D")
snp_all_prop$ancestry <- factor(snp_all_prop$ancestry, levels = c("ER", "OB", "C", "AG", "D"))
ggplot(snp_all_prop) + 
  geom_col(aes(x = ind, y = proportion, fill = ancestry), width = 1) + 
  scale_fill_manual(values = turbo_col) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, h = 1, vjust = 0.5))
```


### snmf on African+TRs
```{r}
kiss_dir <- "/shared/projects/most_kmer/kiss_all/output/"
bed_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bed")
matrix <- BEDMatrix(bed_file, simple_names = T)

# bim_file <- file.path(kiss_dir, "3.TABLE2BED/output_file.4.bim")
# bim <- read_delim(bim_file, delim = "\t", col_names = F)

kmer_file <- file.path(kiss_dir, "5.RANGES/output_file.4/15.txt")
kl <- scan(kmer_file)

kmer_names_list <- sort(kl) # kmer number by segment
submat <- matrix[!grepl("S-", rownames(submat)), sort(kl)]


all_sample_file <- "/shared/projects/most_kmer/kiss_all/samples/all_sample_name.txt"
all_sample <- read.delim(all_sample_file)

all_kiss_file <- "/shared/projects/most_kmer/kiss_all/samples/all_sample.txt"
all_kiss <- read.delim(all_kiss_file)

all_sample <- left_join(all_kiss %>% select(accession_id), all_sample)
aftr_sample <- all_sample %>% 
  filter(!grepl("S-", accession_id))

## SNMF
snmf_dir <- file.path(".", "snmf")
dir.create(snmf_dir, showWarnings = F)
geno_file <- file.path(snmf_dir, "aftr_kmer.geno")
write.geno(submat, geno_file)

aftr_snmf_kmer <- snmf(geno_file, K = 1:10, CPU = 54, repetitions = 10, project = "new", entropy = T, seed = 987654321)
aftr_snmf_kmer <- load.snmfProject("./snmf/aftr_kmer.snmfProject")
plot(aftr_snmf_kmer)
```

```{r}
## best k = 5
## choose best run based on cross entropy
k <- 5
best_run <- which.min(cross.entropy(aftr_snmf_kmer, K = k))

## plot ancestry proportion
ind_order <- LEA::barchart(aftr_snmf_kmer, K = k, run = best_run, plot = F)
kmer_aftr_prop <- as.data.frame(Q(aftr_snmf_kmer, K = k, run = best_run))
kmer_aftr_prop$Label <- paste(aftr_sample$accession_id, aftr_sample$phenotype_value, sep = "_")
kmer_aftr_prop$prior <- factor(aftr_sample$phenotype_value, levels = c("ER", "OB", "C", "AG", "D"))
kmer_aftr_prop <- pivot_longer(kmer_aftr_prop, cols = V1:V5, names_to = "ancestry", values_to = "proportion")
## rename ancestry
repre <- kmer_aftr_prop %>% 
  filter(!grepl("TR", Label)) %>% 
  group_by(ancestry) %>% 
  arrange(desc(proportion)) %>% 
  slice_head(n = 1) %>% slice_tail(n = 1)

# ind_order <- kmer_aftr_prop %>% 
#   group_by(Label) %>% 
#   slice_max(proportion) %>% 
#   arrange(ancestry, desc(proportion)) %>% 
#   pull("Label") %>% as.character()

kmer_aftr_prop$Label <- factor(kmer_aftr_prop$Label, 
                               levels = c(unique(kmer_ref_prop$Label)[ind_order_kmer$order], 
                                          grep("TR", unique(kmer_aftr_prop$Label)[ind_order$order], value = T), 
                                          ordered = F))
kmer_aftr_prop$ancestry <- sapply(kmer_aftr_prop$ancestry, function(i) repre$prior[repre$ancestry == i], USE.NAMES = F)
kmer_aftr_prop <- kmer_aftr_prop %>% 
  mutate(group = if_else(grepl("TR", Label), "Vietnam", "Africa"))

tiff("/shared/projects/most_kmer/paper_plot/structure_ref_tr.tiff",
     width = 10, height = 4, units = "in", res = 1200)
ggplot(kmer_aftr_prop) +
  facet_grid(cols = vars(group), scale = "free", space = "free") +
  geom_col(aes(x = Label, y = proportion, fill = ancestry), position = position_stack(), width = .95) + 
  # scale_fill_viridis_d(end = .9)+
  scale_fill_manual(values = turbo(5)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ylab("Ancestry proportion")  +
  xlab("Individual") + 
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.title = element_text(size = 14),
    # axis.title.x = element_blank(),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.key.size = unit(5, "mm"),
    axis.ticks.y = element_line(size = .1),
    axis.text.y = element_text(size = 8),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(size =14)
    ) 
dev.off()
```

## GEA

Below is a trial on a random k-mer set (batch 415) of the african data

### environment variables

```{r}
clim_file <- "./gea/lfmm/lfmm_explanatory_2.1.csv"
clim <- fread(clim_file, data.table = T)
# write.csv(clim[,1:21], "./gea/lfmm/lfmm_explanatory.csv", 
#           row.names = F, quote = F)
clim <- clim %>% column_to_rownames("Label")

# clim <- clim %>% 
#   mutate(snp_group = case_when(snp_group %in% c("A", "G") ~ "AG",
#                                snp_group %in% c("E", "R") ~ "ER",
#                                snp_group %in% c("O", "B") ~ "OB",
#                                TRUE ~ snp_group))
```

```{r}
pairs.panels(clim[,1:20], hist.col = "royalblue", ellipses = F)

```

the correlation of the "annual" variables

```{r}
test_clim <- clim[, c(1,7,12)]
pdf("/data/projects/rob/data/kmers/gea/annual_climate_correlation.pdf")
cor.plot(test_clim)
# legend(1, pch = c(0:5), legend = levels(as.factor(clim$snp_group)))
dev.off()
```

```{r}
svg("/data/projects/rob/data/kmers/gea/climate_correlation_groups.svg")
scatterplotMatrix(test_clim, groups = clim$snp_group)
dev.off()
```

```{r}
test_clim$snp_group <- factor(clim$snp_group, levels = c("ER", "OB", "C", "AG", "D", "hb"))
ggpairs(test_clim, columns = 1:3, aes(color = snp_group)) + 
  scale_color_manual(values = c(turbo(5), "gray")) +
  scale_fill_manual(values = c(turbo(5), "gray")) +
  theme_minimal() +
  theme(panel.background = element_rect(color = "gray"))
ggsave("gea/annual_climate_correlation_groups_gg.svg", width = 8, height = 8)
```

the correlation of the variables maximizing the deviance (Tournebize et al. 2022)

```{r}
test_clim <- clim[, c(2,10,12, 15, 18)]
svg("/data/projects/rob/data/kmers/gea/deviance_climate_correlation.svg")
pairs.panels(test_clim, hist.col = "royalblue", ellipses = F)
# legend(1, pch = c(0:5), legend = levels(as.factor(clim$snp_group)))
dev.off()
```

```{r}
test_clim$snp_group <- factor(clim$snp_group, levels = c("ER", "OB", "C", "AG", "D", "hb"))
ggpairs(test_clim, columns = 1:5, aes(color = snp_group)) + 
  scale_color_manual(values = c(turbo(5), "gray")) +
  scale_fill_manual(values = c(turbo(5), "gray")) +
  theme_minimal() +
  theme(panel.background = element_rect(color = "gray"))
ggsave("gea/deviance_climate_correlation_groups_gg.svg", width = 8, height = 8)
```

distribution of all the variables by group

```{r}
# ggpairs(clim, columns = 1:19, aes(color = snp_group)) + 
#   scale_color_manual(values = c(turbo(5), "gray")) +
#   scale_fill_manual(values = c(turbo(5), "gray")) +
#   theme_minimal() +
#   theme(panel.background = element_rect(color = "gray"))

clim %>% group_by(snp_group) %>% summarise(nb_inds = n())

clim$snp_group <- factor(clim$snp_group, levels = c("hb", "ER", "OB", "C", "AG", "D"))
clim[,c(1:20, ncol(clim))] %>% 
  pivot_longer(cols = 1:20, names_to = "variable") %>% 
  mutate(variable = factor(variable, 
                           levels = str_sort(unique(variable), numeric = T))) %>% 
  filter(snp_group != "hb") %>% 
  rename(group = snp_group) %>% 
  ggplot() +
  facet_wrap(~ variable, ncol = 5, scale = "free") +
  geom_density(aes(value, color = group, fill = group), alpha = 0.5) +
  scale_color_manual(values = turbo(5)) +
  scale_fill_manual(values =  turbo(5)) +
  theme_minimal()
```

```{r}
library(rnaturalearth)
group_col <- c("#FB8022FF", "#A2FC3CFF", "#7A0403FF", "#30123BFF", "#28BBECFF")

africa <- ne_countries(scale = "medium", continent = "africa", returnclass = "sf")


africa <- africa %>% 
  mutate(ancestry = case_when(sovereignt %in% c("Ivory Coast", "Guinea", "Ghana") ~ "D",
                              sovereignt == "Cameroon" ~ "C",
                              sovereignt %in% c("Gabon", "Benin", "Angola") ~ "AG",
                              sovereignt %in% c("Uganda", "Central African Republic") ~ "OB",
                              sovereignt == "Democratic Republic of the Congo" ~ "ER"))

rob_countries <- africa %>% filter(!is.na(ancestry))

ggplot(data = africa) +
  geom_sf(fill = "white", color = "grey") +
  geom_point(data = clim, aes(x = Long, y = Lat, color = snp_group)) +
  stat_density2d(data = clim, aes(x = Long, y = Lat, fill = snp_group), alpha = .5,
                 geom = "polygon") +
  # geom_sf(data = rob_countries, aes(fill = ancestry), color = "grey") +
  # geom_sf_text(data = rob_countries, aes(label = abbrev), color = "grey50") +
  scale_color_manual(values = c(group_col, "gray"), na.value = "grey50") +
  scale_fill_manual(values = c(group_col, "gray"), na.value = "grey50") +
  coord_sf(xlim = c(-15, 48), ylim = c(-40, 35), expand = TRUE) +
  theme_void() +
  theme(legend.box.margin = margin(l = 20), 
        legend.key.size = unit(14, "pt"),
        legend.key.height = unit(15, "pt"))
```

### toy genotype

```{r}
submat1 <- submat
# rownames(submat1) <- gsub("_.+", "", rownames(submat1))
submat1 <- submat1[rownames(submat1) %in% rownames(clim),]
```

### lfmm with all variables

```{r}
k <- 5 # based on pcadapt and snmf results
```

```{r}
suball_lfmm <- lfmm_ridge(Y = submat1, X = clim[, 1:20], K = k)
pv <- lfmm_test(Y = submat1, X = clim[, 1:20], 
                lfmm = suball_lfmm, 
                calibrate = "gif")
hist(pv$calibrated.pvalue)

test_lffm_res <- "./gea/test_lfmm_results.pdf"
pdf(test_lffm_res)
for (i in 1:ncol(clim[, 1:20])) {
  pvalues <- pv$calibrated.pvalue[,i]
  # hist(pvalues, 
  #      main = paste0("Calibrated p-values for ", colnames(clim[, 1:20])[i], 
  #                    " (GIF = ", sprintf("%.2f", pv$gif[i]), ")"),
  #      xlab = "p-values")
  qqplot(rexp(length(pvalues), rate = log(10)),
       -log10(pvalues), 
       xlab = "Expected quantile", main = colnames(clim[, 1:20])[i], 
       pch = 19, cex = .4)
  abline(0,1)
}
dev.off()
```

```{r}
associated_kmers <- rownames(pv$calibrated.pvalue)[sapply(1:nrow(pv$calibrated.pvalue), function(i) any(pv$calibrated.pvalue[i, 1:19] < 0.05))]
length(unique(associated_kmers))

u <- 0
for (i in 1:19) {
  cat(paste0("bio", i, ": "))
  v <- length(rownames(pv$calibrated.pvalue)[pv$calibrated.pvalue[,i] < 0.05])
  u <- u + v
  cat(v)
  cat("\n")
  }
```

-> 507468 significant k-mers -> the histogram seems fine but half of the k-mers are significant

### lfmm with only annual climatic variables

```{r}
subann_lfmm <- lfmm_ridge(Y = submat1, X = clim[, c(1,3,7,12)], K = k)
pv_ann <- lfmm_test(Y = submat1, X = clim[, c(1,3,7,12)], 
                    lfmm = subann_lfmm, 
                    calibrate = "gif")
hist(pv_ann$calibrated.pvalue)

signif_ann <- rownames(pv_ann$calibrated.pvalue)[sapply(1:nrow(pv_ann$calibrated.pvalue), function(i) any(pv_ann$calibrated.pvalue[i,] < 0.05))]
length(unique(signif_ann))
```

-> 263789 significant k-mers

### lfmm with pca axes

```{r}
clim_pca <- rda(clim[,1:19], scale = T)
summary(clim_pca)$cont
round(scores(clim_pca, choices = 1:2, display = "species", scaling = 0), digits = 3)
biplot(clim_pca)
```

```{r}
clim_pure <- clim[clim$snp_group != "hb",]
clim_pca2 <- prcomp(clim_pure[,1:20], scale = T)
summary(clim_pca2)
screeplot(clim_pca2)
library(ggfortify)
clim_pure$snp_group <- factor(clim_pure$snp_group, levels = c("ER", "OB", "C", "AG", "D"))
## PC1 vs PC2
autoplot(clim_pca2, x = 1, y = 2,
         data = clim_pure, colour = 'snp_group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5))) +
  scale_fill_manual(values = c(turbo(5))) 

## PC1 vs PC2
autoplot(clim_pca2, x = 1, y = 3,
         data = clim_pure, colour = 'snp_group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5))) +
  scale_fill_manual(values = c(turbo(5))) 
  
```

```{r}
test_clim_pca <- clim[, c(12,14,17)]
svg("/data/projects/rob/data/kmers/gea/climate_correlation.svg")
pairs.panels(test_clim_pca, hist.col = "royalblue", ellipses = F, pch = c(0:5)[as.factor(clim$snp_group)])
legend(1, pch = c(0:5), legend = levels(as.factor(clim$snp_group)))
dev.off()

ggpairs(clim, columns = c(12,14,17), aes(color = snp_group)) + 
  scale_color_manual(values = c(turbo(5), "gray")) +
  scale_fill_manual(values = c(turbo(5), "gray")) +
  theme_minimal() +
  theme(panel.background = element_rect(color = "gray"))

ggpairs(clim, columns = c(1,5,8:10), aes(color = snp_group)) + 
  scale_color_manual(values = c(turbo(5), "gray")) +
  scale_fill_manual(values = c(turbo(5), "gray")) +
  theme_minimal() +
  theme(panel.background = element_rect(color = "gray"))
```

```{r}
clim_PC1 <- scores(clim_pca, choices = 1, display = "sites", scaling = 0)
subpca_lfmm <- lfmm_ridge(Y = submat1, X = clim_PC1, K = k)

pv_pca <- lfmm_test(Y = submat1, X = clim_PC1, 
                    lfmm = subpca_lfmm, 
                    calibrate = "gif")
hist(pv_pca$calibrated.pvalue)
pv_pca$gif

signif_pca <- rownames(pv_pca$calibrated.pvalue)[sapply(1:nrow(pv_pca$calibrated.pvalue), function(i) any(pv_pca$calibrated.pvalue[i,] < 0.05))]
length(unique(signif_pca))
```

```{r}
clim_PC2 <- scores(clim_pca, choices = 1:2, display = "sites", scaling = 0)
subpca2_lfmm <- lfmm_ridge(Y = submat1, X = clim_PC2, K = k)

pv_pca2 <- lfmm_test(Y = submat1, X = clim_PC2, 
                    lfmm = subpca2_lfmm, 
                    calibrate = "gif")
hist(pv_pca2$calibrated.pvalue)
for (i in 1:2) {
  hist(pv_pca2$calibrated.pvalue[,i], 
       main = paste0("Calibrated p-values for PC", i, 
                     " (GIF = ", sprintf("%.2f", pv_pca2$gif[i]), ")"),
       xlab = "p-values")
}
pv_pca2$gif

signif_pca2 <- rownames(pv_pca2$calibrated.pvalue)[sapply(1:nrow(pv_pca2$calibrated.pvalue), function(i) any(pv_pca2$calibrated.pvalue[i,] < 0.05))]
length(unique(signif_pca2))

plot(-log10(pv_pca2$calibrated.pvalue[,1]), 
      pch = 19, 
      cex = .2, 
      xlab = "k-mer", ylab = "-Log P",
      col = "grey")
plot(-log10(pv_pca2$calibrated.pvalue[,2]), 
      pch = 19, 
      cex = .2, 
      xlab = "k-mer", ylab = "-Log P",
      col = "grey")
```

-> 144573 k-mers

### genome-wide lfmm using pca of clim vars

gather all the lfmm results for all the k-mer batches

```{r}
lfmm_out <- "/data/projects/rob/scripts/kmer/gea/lfmm/out"
lfmm_files <- list.files(lfmm_out, pattern = ".*.csv", full.names = T, recursive = T)
all_lfmm <- file.path(lfmm_out, "all_candidates.csv")
file.append(all_lfmm, lfmm_files)
```

count the number of total candidate kmers

```{bash}
wc -l /data/projects/rob/scripts/kmer/gea/lfmm/out/all_candidates.csv
```

-> 218,269,911 k-mers (12%)

### genome-wide lfmm using all the 19 clim vars

we decided to use all the 19 variables since we can associate k-mers to each climatic variable

for working on IFB: transfer kiss results from Itrop to IFB\
(because running 1728 independent jobs on IFB is much x3000 faster)

```{bash update_ifb}
cd /shared/projects/most_kmer
mkdir kiss_out
rsync -vaurP baotram@bioinfo-nas2.ird.fr:/data/projects/rob/scripts/kmer/gea/tmp/* kiss_out/
mkdir -p /shared/projects/most_kmer/afterkiss/gea/lfmm/log
sbatch /shared/projects/most_kmer/afterkiss/gea/lfmm/run_lfmm_af_IFB.sh
```

```{bash}
ssh baotram@core.cluster.france-bioinformatique.fr
module load singularity
singularity exec -B /shared/home/baotram \
/shared/projects/vietcaf/rserver/Singularity.R_4-2-0-Rserver_2022.sif \
Rscript /shared/projects/most_kmer/afterkiss/gea/lfmm/install_packages.R
```

then, transfer lfmm results from IFB to Itrop

```{bash}
rsync -vaurP baotram@core.cluster.france-bioinformatique.fr:/shared/projects/most_kmer/afterkiss/gea/lfmm/out_K5 /data/projects/rob/scripts/kmer/gea/lfmm/
rsync -vaurP baotram@core.cluster.france-bioinformatique.fr:/shared/projects/most_kmer/afterkiss/gea/lfmm/log/* /data/projects/rob/scripts/kmer/gea/lfmm/log_K5
```

check if all the runs have finished

```{r}
lfmm_out <- "./gea/lfmm/out_K5"
real <- dirname(list.files(lfmm_out, "lfmm_results.pdf", full.names = F, recursive = T))
length(real)

n <- 1728
expect <- sapply(1:n, function(r) {
  if (r %% 100 == 0) {
    b <- r/100 - 1
    s <- 100
  } else {
    b <- r %/% 100
    s <- r %% 100
  }
  return(paste(b, s, sep = "_"))
})
length(expect)

# files that haven't finished
expect[!expect %in% real]
```

gather all the lfmm results for all the k-mer batches using the results directly

```{r}
all_lfmm_dir <- "./gea/lfmm/all_bio"
dir.create(all_lfmm_dir, showWarnings = T)
lfmm_files <- list.files(lfmm_out, pattern = "_bio1.csv", full.names = T, recursive = T)
all_lfmm <- file.path(all_lfmm_dir, "all_candidates_bio1.csv")
file.append(all_lfmm, lfmm_files)

for (i in 1:19) {
  lfmm_files <- list.files(lfmm_out, pattern = paste0("_bio", i, ".csv"), 
                           full.names = T, recursive = T)

}

## below: it works but very slow and memory consuming
library(R.utils)

cand_kmers <- rowSums(do.call(cbind, lapply(expect, function(i) {
  cand_files <- list.files(file.path(lfmm_out, i), "candidates_.+.csv", full.names = T)
  do.call(rbind, lapply(cand_files, function(f) {
    varname <- gsub("(.+_|.csv)", "", basename(f))
    df <- data.frame(countLines(f))
    colnames(df) <- which(f %in% cand_files)
    rownames(df) <- varname
    return(df)
    }))
})))
```

gather all the lfmm results for all the k-mer batches using the log files (faster i think)

```{r}
log_K5 <- "./gea/lfmm_rda/log"
log_files <- list.files(log_K5, pattern = "slurm-gea_af_all_\\d+.log", full.names = T)
n <- length(log_files)

cand_kmers <- rowSums(do.call(cbind, lapply(1:n, function(i) {
  cat(i, "\n")
  df <- fread(log_files[i], skip = 11, nrows = 19, sep = "\t", 
              # select = c(7, 9), col.names = c("var", i),
              data.table = FALSE)
  # df$variable <- colnames(pv$calibrated.pvalue)
  df <- df %>% column_to_rownames("variable")
  # if (rownames(df)[20] == "elevation") {cat(i, "\n")}
  return(df)
  })
  ))
cand_kmers <- format(as.data.frame(cand_kmers), big.mark = ",")
```

the histograms and qq-plots are not good (stares, uniform distribution)




### lfmm of putative adaptive kmers

so, we try to run lfmm only for the putative adaptive kmers to see if we have better p-values distribution  
for each batch, run pcadapt to select adaptive kmers, then run lfmm for only these adaptive ones.


```{r}
lfmm_out <- "./gea/lfmm/out_K5_outlier/"
real <- dirname(list.files(lfmm_out, "lfmm_results.pdf", full.names = F, recursive = T))
length(real)

n <- 1728
expect <- sapply(1:n, function(r) {
  if (r %% 100 == 0) {
    b <- r/100 - 1
    s <- 100
  } else {
    b <- r %/% 100
    s <- r %% 100
  }
  return(paste(b, s, sep = "_"))
})
length(expect)

# files that haven't finished
expect[!expect %in% real]
```

```{r}
library(R.utils)

cand_kmers <- rowSums(do.call(cbind, lapply(expect, function(i) {
  cand_files <- list.files(file.path(lfmm_out, i), "candidates_.+.csv", full.names = T)
  do.call(rbind, lapply(cand_files, function(f) {
    varname <- gsub("(.+_|.csv)", "", basename(f))
    df <- data.frame(countLines(f))
    colnames(df) <- which(f %in% cand_files)
    rownames(df) <- varname
    return(df)
    }))
})))
```


### RDA

```{r}
sub_rda <- rda(submat1 ~ ., data = clim)
sub_rda_sum <- summary(sub_rda)
sub_rda_sum
RsquareAdj(sub_rda)
screeplot(sub_rda)
vif.cca(sub_rda)
plot(sub_rda, scaling = 3)
axis_test <- anova(sub_rda, by = "axis")
# anova.cca(sub_rda, step = 100, by = "axis")
```
22% genetic variance is explained by genetic structure
32% explained by environment variables


#### select candidate kmers as suggested in here https://bookdown.org/hhwagner1/LandGenCourse_book/WE_11.html
```{r}
kmer_loads <- summary(sub_rda)$species
hist(kmer_loads[,1])
hist(kmer_loads[,2])

outliers <- function(x,z){
  lims <- mean(x) + c(-1, 1) * z * sd(x)     # find loadings +/-z sd from mean loading     
  x[x < lims[1] | x > lims[2]]               # locus names in these tails
}

cand_rda1 <- outliers(kmer_loads[,1], 2)
length(cand_rda1)
cand_rda2 <- outliers(kmer_loads[,2], 2)
length(cand_rda2)
signif_rda1 <- unique(unlist(lapply(1:4, function(v) {
  cand <- outliers(kmer_loads[,v], 2.5)
  return(names(cand))
})))
length(signif_rda1)

p <- pnorm(kmer_loads[,1], mean = mean(kmer_loads[,1]), sd = sd(kmer_loads[,1]), lower.tail = T)
signif_rda1 <- unique(unlist(lapply(1:4, function(v) {
  kmer_test <- kmer_loads[,v]
  p <- pnorm(kmer_test, mean = mean(kmer_test), sd = sd(kmer_test), lower.tail = T)
  cand <- names(kmer_test)[p < 0.05]
  return(cand)
})))
length(signif_rda1)
```

-> 183,555 candidate k-mers
-> 45% genetic variance is explained by environment variables

#### use mahalanobis method to select candidate kmers

```{r}
set.seed(5)
sub_loads <- as.data.frame(rda$CCA$v[,1:2])
dfree <- ncol(sub_loads) - 1
sub_loads$mahalnobis <- mahalanobis(sub_loads, colMeans(sub_loads), cov(sub_loads))
gif <- median(sub_loads$mahalnobis)/(dfree*(1-2/(9*dfree))**3) #median(rchisq(n = nrow(sub_loads), df = dfree))
sub_loads$mahalnobis_gif <- sub_loads$mahalnobis**2/gif
# hist(sub_loads$mahalnobis_gif)
sub_loads$pvalue <- pchisq(sub_loads$mahalnobis_gif, df = dfree, lower.tail = FALSE)
# hist(sub_loads$pvalue)
sub_qvalue <- qvalue(sub_loads$pvalue, fdr.level = 0.01, pfdr = F)
signif_rda2 <- rownames(sub_loads)[sub_qvalue$significant]
length(signif_rda2)

signif_rda2 <- rownames(sub_loads)[sub_loads$pvalue < 0.01]
length(signif_rda2)

sub_loads$pvalue <- pchisq(sub_loads$mahalnobis, df = dfree, lower.tail = FALSE)
signif_rda2 <- rownames(sub_loads)[sub_loads$pvalue < 0.05]
length(signif_rda2)

sub_loads$pvalue <- pchisq(sub_loads$mahalnobis, df = dfree, lower.tail = FALSE)
sub_qvalue <- qvalue(sub_loads$pvalue, fdr.level = 0.01, pfdr = T)
signif_rda2 <- rownames(sub_loads)[sub_qvalue$significant]
length(signif_rda2)
```

-> 178,856 candidate k-mers


#### rdadapt method

```{r}
rdadapt<-function(rda,K)
{
zscores<-rda$CCA$v[,1:as.numeric(K)]
resscale <- apply(zscores, 2, scale)
resmaha <- covRob(resscale, distance = TRUE, na.action= na.omit, estim="pairwiseGK")$dist
lambda <- median(resmaha)/qchisq(0.5,df=K)
reschi2test <- pchisq(resmaha/lambda,K,lower.tail=FALSE)
qval <- qvalue(reschi2test)
q.values_rdadapt<-qval$qvalues
return(data.frame(p.values=reschi2test, q.values=q.values_rdadapt))
}
signif_rdadapt <- rdadapt(sub_rda, 2)
hist(signif_rdadapt$p.values)
signif_rda3 <- rownames(sub_rda$CCA$v)[signif_rdadapt$q.values < 0.01]
length(signif_rda3)
```

#### Compare with LFMM result
```{r}
signif_lfmm <- fread("/shared/projects/most_kmer/afterkiss/gea/lfmm/out_K5/4_15/candidates_kmers.csv")
nrow(signif_lfmm)
length(signif_rda1[signif_rda1 %in% signif_lfmm$sequence])/nrow(signif_lfmm)
length(signif_rda2[signif_rda2 %in% signif_lfmm$sequence])/nrow(signif_lfmm)
length(signif_rda3[signif_rda3 %in% signif_lfmm$sequence])/nrow(signif_lfmm)
```

-> LFMM: 53,118 k-mers
-> LFMM + RDA1 -> 10,075 k-mers
-> LFMM + RDA2 -> 9,804 k-mers

### partial RDA

```{r}
## PCA
sub_pca <- rda(submat1, scale = F)
screeplot(sub_pca)
sub_cont <- scores(sub_pca, choices = 1:2, display = "sites")

test_clim <- cbind(clim, sub_cont)
pairs.panels(test_clim, hist.col = "royalblue", ellipses = F)
test_clim <- as.data.frame(scale(test_clim))

sub_prda <- rda(submat1 ~ . - PC1 - PC2 + Condition(PC1 + PC2), 
                data = test_clim, 
                scale = T)
sub_prda_sum <- summary(sub_prda)
sub_prda_sum
RsquareAdj(sub_prda)
screeplot(sub_prda)
vif.cca(sub_prda)
plot(sub_prda, scaling = 3)
# anova.cca(sub_rda, step = 100, by = "axis")
```
22% genetic variance is explained by genetic structure
32% explained by environment variables


```{r}
saveRDS(sub_prda, "./gea/rda_test_sub_rda.RDS")
sub_prda <- readRDS("./gea/rda_test_sub_rda.RDS")
```

#### select candidate kmers as suggested in here https://bookdown.org/hhwagner1/LandGenCourse_book/WE_11.html
```{r}
kmer_loads_prda <- summary(sub_prda)$species
hist(kmer_loads_prda[,1])
hist(kmer_loads_prda[,2])

outliers <- function(x,z){
  lims <- mean(x) + c(-1, 1) * z * sd(x)     # find loadings +/-z sd from mean loading     
  x[x < lims[1] | x > lims[2]]               # locus names in these tails
}

signif_prda1 <- unique(unlist(lapply(1:5, function(v) {
  cand <- outliers(kmer_loads_prda[,v], 2.5)
  return(names(cand))
})))
length(signif_prda1)
# cand_prda1 <- outliers(kmer_loads_prda[,1], 2)
# length(cand_prda1)
# cand_prda2 <- outliers(kmer_loads_prda[,2], 2)
# length(cand_prda2)
# signif_prda1 <- unique(names(c(cand_prda1, cand_prda2)))
# length(signif_prda1)
```

-> 102,990 candidate k-mers

#### use mahalanobis method to select candidate kmers

```{r}
sub_loads_prda <- as.data.frame(sub_prda_sum$species)[,1:2]
dfree <- ncol(sub_loads_prda) - 1
sub_loads_prda$mahalnobis <- mahalanobis(sub_loads_prda, colMeans(sub_loads_prda), cov(sub_loads_prda))
gif <- median(sub_loads_prda$mahalnobis)/(dfree*(1-2/(9*dfree))**3) #median(rchisq(n = nrow(sub_loads_prda), df = dfree))
sub_loads_prda$mahalnobis_gif <- sub_loads_prda$mahalnobis**2/gif
# hist(sub_loads_prda$mahalnobis_gif)
sub_loads_prda$pvalue <- pchisq(sub_loads_prda$mahalnobis_gif, df = dfree, lower.tail = FALSE)
# hist(sub_loads_prda$pvalue)
sub_qvalue <- qvalue(sub_loads_prda$pvalue, fdr.level = 0.01, pfdr = T)
signif_prda2 <- rownames(sub_loads_prda)[sub_qvalue$significant]
length(signif_prda2)
```
-> 51,307 candidate kmers


#### rdadapt method
```{r}
rdadapt<-function(rda,K)
{
zscores<-rda$CCA$v[,1:as.numeric(K)]
resscale <- apply(zscores, 2, scale)
resmaha <- covRob(resscale, distance = TRUE, na.action= na.omit, estim="pairwiseGK")$dist
lambda <- median(resmaha)/qchisq(0.5,df=K)
reschi2test <- pchisq(resmaha/lambda,K,lower.tail=FALSE)
qval <- qvalue(reschi2test)
q.values_rdadapt<-qval$qvalues
return(data.frame(p.values=reschi2test, q.values=q.values_rdadapt))
}
signif_prdadapt <- rdadapt(sub_prda, 2)
hist(signif_prdadapt$p.values)
signif_prda3 <- rownames(sub_loads_prda)[signif_prdadapt$q.values < 0.05]
length(signif_prda3)
```


#### Compare with LFMM result
```{r}
signif_lfmm <- fread("/shared/projects/most_kmer/afterkiss/gea/lfmm/out_K5/4_15/candidates_kmers.csv")
nrow(signif_lfmm)
length(signif_prda1[signif_prda1 %in% signif_lfmm$sequence])
length(signif_prda2[signif_prda2 %in% signif_lfmm$sequence])/nrow(signif_lfmm)
length(signif_prda3[signif_prda3 %in% signif_lfmm$sequence])/nrow(signif_lfmm)
```
-> RDA is better than partial RDA (more common kmers with LFMM), it was also shown on published papers.


#### Gather all RDA runs
```{bash}
cd /shared/projects/most_kmer/afterkiss/gea/rda
candfiles=$(ls out_2.5sd/*/candidates_rda.txt)
echo -e "sequence\tkmer_nb\tbed_file" > significant_kmers_rda.txt
for f in $candfiles; do echo $f; cat $f | cut -f3,2,1 | sed -n '1d;p' | awk '{ print $3 "\t" $2 "\t" $1}' >> significant_kmers_rda.txt; done
```
-> 85,567,757 candidate kmers

### Common of LFMM and RDA

```{r}
com_files <- list.files("./gea/lfmm_rda/out/4_15", "candidates_rda_lfmm.txt", 
                        recursive = T, full.names = T)
com <- fread(com_files[1], header = F)
signif_mat <- submat1[,colnames(submat1) %in% com$V1]

```

```{r}
log <- "./gea/lfmm_rda/log"
log_files <- list.files(log, pattern = "slurm-gea_af_all_\\d+.log", full.names = T)
n <- length(log_files)

cand_kmers <- do.call(rbind, lapply(1:n, function(i) {
  cat(i, "\n")
  df <- fread(log_files[i], skip = 11, nrows = 19, sep = "\t", 
              # select = c(7, 9), col.names = c("var", i),
              data.table = FALSE)
  # df <- df %>% column_to_rownames("variable")
  return(df)
  })
  )
cand_kmers <- cand_kmers %>% 
  group_by(variable) %>% 
  summarise(across(significant_kmers:significant_outliers, sum)) %>% 
  dplyr::select(variable, significant_kmers) %>% 
  arrange(desc(significant_kmers))

cand_kmers <- format(as.data.frame(cand_kmers), big.mark = ",")
```


## Climatic condition in Central Highlands VN

- Following [this paper](https://doi.org/10.3389/fenvs.2022.820916): select a random point in each district, and get bioclim variables.
    + How to get the coordinates? get the map of the Central Highlands (by raster package) then extract the mid point of each district  
    -> there are 62 districts in the central highlands

- Then, run PCA of bioclim variables (with and without elevation) to see how they are different from the condition in Africa.

### Coordinates of all districts in the Central Highlands
```{r}
vn <- getData("GADM", country = "VN", level = 2)

ch_provinces <- c("Lâm Đồng", "Đắk Lắk", "Đắk Nông", "Kon Tum", "Gia Lai")
# ch_provinces <- "Đắk Lắk"
ch_map <- vn[vn$NAME_1 %in% ch_provinces, ]
length(ch_map$NAME_2)

chdist_coord <- do.call(rbind, lapply(ch_map$NAME_2, function(d) {
  dist_map <- ch_map[ch_map$NAME_2 == d,]
  coord <- data.frame(province = dist_map$NAME_1,
                      district = dist_map$NAME_2,
                      coordinates(dist_map)
                      )
  colnames(coord)[3:4] <- c("long", "lat")
  return(coord)
}))
```


### Bioclim variables of the districts

```{r}

bioclim <- readRDS("./gea/bioclim_2.1.RDS")
elev_data <- readRDS("./gea/elevation0.5_v2.1.RDS")
chvar <- do.call(rbind, lapply(1:nrow(chdist_coord), function(i) {
  # clim <- getData(name = "worldclim", var = "bio", res = 0.5, lat = na.omit(chdist_coord$lat)[i], lon = na.omit(chdist_coord$long)[i])
  # elev <- getData(name = "SRTM", lat = na.omit(chdist_coord$lat)[i], lon = na.omit(chdist_coord$long)[i])
  point <- SpatialPoints(data.frame(long = na.omit(chdist_coord$long)[i], lat = na.omit(chdist_coord$lat)[i]), proj4string = bioclim@crs)
  clim_values <- raster::extract(bioclim, point)
  elev_value <- raster::extract(elev_data, point)
  colnames(clim_values) <- gsub("_.+", "", colnames(clim_values))
  df <- data.frame(district = chdist_coord$district[i], 
                   clim_values, 
                   elevation = elev_value,
                   Long = chdist_coord$long[i], Lat = chdist_coord$lat[i],
                   group = "VN")
  return(df)
}))
chvar <- chvar %>% 
  column_to_rownames("district")
```


```{r}
all_clim <- getData(name = "worldclim", var = "bio", res = 2.5)

vn_clim <- raster::mask(all_clim, ch_map)
plot(vn_clim[[1:19]], ylim = c(11, 16), xlim = c(105, 110), axes = F, 
     col = viridis::cividis(100), add = T)
```


### Distribution of clim variables in Africa + VN

```{r}
clim_all <- rbind(chvar,
      clim %>% rename(group = snp_group))

clim_groups <- clim_all %>% 
  filter(group != "hb")

clim_groups$group <- factor(clim_groups$group, levels = c("ER", "OB", "C", "AG", "D", "VN"))

clim_groups %>% 
  filter(group != "hb") %>%  
  pivot_longer(cols = 1:20, names_to = "variable") %>% 
  mutate(variable = factor(variable, 
                           levels = str_sort(unique(variable), numeric = T))) %>% 
  ggplot() +
  facet_wrap(~ variable, ncol = 5, scale = "free") +
  geom_density(aes(value, color = group, fill = group), alpha = 0.5) +
  scale_color_manual(values = c(turbo(5), "black")) +
  scale_fill_manual(values = c(turbo(5), "black")) +
  theme_minimal()
```

### PCA of clim variables in Africa+VN
```{r}
climall_pca <- prcomp(clim_groups[,1:20], scale = T)
summary(climall_pca)
screeplot(climall_pca)

## PC1 vs PC2
autoplot(climall_pca, x = 1, y = 2,
         data = clim_groups, colour = 'group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5), "black")) +
  scale_fill_manual(values = c(turbo(5), "black")) 

## PC1 vs PC3
autoplot(climall_pca, x = 1, y = 3,
         data = clim_groups, colour = 'group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5), "black")) +
  scale_fill_manual(values = c(turbo(5), "black")) 
```


```{r}
climall_pca <- prcomp(clim_groups[,1:19], scale = T)
summary(climall_pca)
screeplot(climall_pca)

## PC1 vs PC2
autoplot(climall_pca, x = 1, y = 2,
         data = clim_groups, colour = 'group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5), "black")) +
  scale_fill_manual(values = c(turbo(5), "black")) 

## PC1 vs PC2
autoplot(climall_pca, x = 1, y = 3,
         data = clim_groups, colour = 'group', size = 2,
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 6,
         loadings.label.colour = "black", frame = T) +
  theme_minimal() + 
  scale_colour_manual(values = c(turbo(5), "black")) +
  scale_fill_manual(values = c(turbo(5), "black")) 
```

## Genetic offset

```{r}
fut_clim <- fread("./bioclim/climatic_variables_vn_future_ipsl.csv")
fut_clim <- fut_clim %>% 
  relocate(str_sort(colnames(fut_clim), numeric = T)) 
colnames(fut_clim) <- gsub("bio", "bio_", colnames(fut_clim))
pred_clim <- matrix(rep(as.numeric(fut_clim[1,1:19]), nrow(clim)), nrow = nrow(clim), byrow = T)
# rownames(pred_clim) <- rownames(clim)
# colnames(pred_clim) <- colnames(clim)[1:19]
```

```{r}
g.gap.scaled <- genetic.gap(input = signif_mat,
                            env = matrix(unlist(clim[,1:19]), nrow = nrow(clim)),
                            pred.env = pred_clim,
                            scale = TRUE,
                            K = 2)

g.gap.scaled <- genetic.gap(input = signif_mat,
                            env = X[1:57,],
                            pred.env = X.pred[1:57,],
                            scale = TRUE,
                            K = 2)
```

